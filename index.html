<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptQuiz - Modern HTML Quiz</title>
    
    <style>
        /* --- Color Variables for Theme Toggle --- */
        :root {
            --bg-color: #f4f4f9; 
            --text-color: #333;
            --card-bg: #fff;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --success-color: #4CAF50;
            --error-color: #f44336;
            --orange-color: #ff9800; /* New Orange */
            --admin-color: #5b3e94; /* Admin Panel Color */
            --delete-color: #dc3545;
            --edit-color: #ffc107;
            --load-color: #00bcd4; /* For Load/Edit Button */
        }

        .dark-mode {
            --bg-color: #121212; 
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --primary-color: #90caf9;
            --primary-hover: #64b5f6;
        }

        /* --- Global Reset & Layout --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .quiz-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            padding: 30px;
            width: 90%;
            max-width: 700px;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }

        /* --- Header & Timer --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #ccc3;
            padding-bottom: 15px;
        }

        .timer {
            font-weight: bold;
            color: var(--primary-color);
        }

        /* --- Welcome Screen Styling --- */
        #welcome-screen {
            text-align: center;
            padding: 40px 0;
        }
        .logo-placeholder {
            width: 100px;
            height: 100px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            color: white;
            font-weight: bold;
        }
        .name-input-container {
            margin-bottom: 30px;
        }
        #user-name-input {
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 80%;
            max-width: 300px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .selection-group {
            margin-top: 20px;
            text-align: left;
        }
        .selection-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            text-align: center;
        }
        .selection-group select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
        }
        .selection-group button {
            width: 100%;
        }

        /* --- Quiz Screen Styles --- */
        #question-text { font-size: 1.5em; margin-top: 0; color: var(--text-color); }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .option-btn { background-color: var(--bg-color); color: var(--text-color); border: 2px solid #ccc; padding: 15px; text-align: left; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, transform 0.1s; font-size: 1em; }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); transform: translateY(-2px); }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        #fill-in-input { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px solid #ccc; border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); box-sizing: border-box; font-size: 1em; }

        /* --- Buttons (General) --- */
        .main-btn, #theme-toggle, .secondary-btn, .admin-btn, .edit-btn, .delete-btn, .load-btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600; 
            transition: background-color 0.2s, opacity 0.2s; 
            margin-right: 10px; 
        }
        .main-btn { background-color: var(--primary-color); color: white; margin-top: 10px; }
        .main-btn:hover { background-color: var(--primary-hover); }
        .secondary-btn { background-color: #6c757d; color: white; margin-top: 10px; }
        .secondary-btn:hover { background-color: #5a6268; }
        .admin-btn { background-color: var(--admin-color); color: white; margin-top: 10px; }
        .admin-btn:hover { background-color: #4f3479; }
        .edit-btn { background-color: var(--edit-color); color: #212529; padding: 5px 10px; font-size: 0.9em; margin: 0 5px; }
        .edit-btn:hover { background-color: #e0a800; }
        .delete-btn { background-color: var(--delete-color); color: white; padding: 5px 10px; font-size: 0.9em; margin: 0; }
        .delete-btn:hover { background-color: #bd2130; }
        .load-btn { background-color: var(--load-color); color: white; padding: 5px 10px; font-size: 0.9em; margin: 0; }
        .load-btn:hover { background-color: #0097a7; }
        #theme-toggle { background-color: #6c757d; color: white; padding: 8px 15px; margin-right: 0; }
        
        /* --- Feedback & State Styling --- */
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; }
        .feedback.correct-msg { background-color: var(--success-color); color: white; }
        .feedback.incorrect-msg { background-color: var(--error-color); color: white; }
        .feedback.edit-btn { background-color: var(--edit-color); color: #212529; } /* Use edit color for load feedback */
        .selected.correct { border-color: var(--success-color); background-color: var(--success-color); color: white; }
        .selected.incorrect { border-color: var(--error-color); background-color: var(--error-color); color: white; }

        .hidden { display: none !important; }

        /* --- Results Styling --- */
        #score-circle {
            margin: 20px auto 30px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color);
            border: 4px solid #ccc;
            transition: border-color 0.3s;
        }

        #final-percent {
            font-size: 3em;
            font-weight: bold;
            transition: color 0.3s;
        }
        
        /* Dynamic Score Colors */
        .score-green { color: var(--success-color); border-color: var(--success-color) !important; }
        .score-orange { color: var(--orange-color); border-color: var(--orange-color) !important; }
        .score-red { color: var(--error-color); border-color: var(--error-color) !important; }
        
        /* --- Admin Panel Styles (NEW) --- */
        #admin-login-screen, #create-quiz-screen {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: var(--bg-color);
        }
        
        .management-container {
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .management-container select, .management-container input {
            flex-grow: 1;
        }
        
        .management-buttons {
            display: flex;
            gap: 5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="number"] { /* Added number input */
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
            margin-top: 3px;
        }
        
        .type-specific-fields {
            margin-top: 15px;
            padding: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .option-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .option-input-container input {
            flex-grow: 1;
        }
        
        #edit-mode-indicator {
            padding: 10px;
            text-align: center;
            background-color: var(--edit-color);
            color: #212529;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* --- Print Styles (for Transcript) --- */
        @media print {
            body { background-color: white !important; color: black !important; display: block; }
            .quiz-container { box-shadow: none; border: none; width: auto; max-width: none; }
            header, #quiz-screen, #welcome-screen, .modal-overlay, #toggle-transcript-btn, .feedback, .main-btn, .secondary-btn, #theme-toggle, .selection-group button, #admin-login-screen, #create-quiz-screen { display: none !important; }
            #results-screen { display: block !important; padding: 0; }
            #review-area { display: block !important; }
            #review-area h3 { page-break-before: always; font-size: 1.5em; }
            .review-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-left: 5px solid black !important; }
            .transcript-header { display: block !important; text-align: left; margin-bottom: 20px;}
            
            /* Print style for the score circle, ensure text is readable */
            #score-circle { border: 2px solid #333 !important; }
            #final-percent { color: #333 !important; } 
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <header>
            <div>
                <button id="cancel-quiz-btn" class="secondary-btn hidden">‚ùå Back</button>
            </div>
            <div style="display: flex; align-items: center;">
                <div id="timer-display" class="timer">Time Left: <span id="time">N/A</span></div>
                <button id="theme-toggle" style="margin-left: 10px;">üåô Dark Mode</button>
            </div>
        </header>

        <div id="welcome-screen">
            <div class="logo-placeholder">Q</div>
            <h1>Welcome to ScriptQuiz!</h1>
            <p>Enter your name to proceed to the quiz settings or log in as admin.</p>
            
            <div class="name-input-container">
                <input type="text" id="user-name-input" placeholder="Your Full Name" required>
            </div>
            
            <button id="proceed-to-settings-btn" class="main-btn" disabled>Proceed to Quiz</button>
            <button id="show-admin-login-btn" class="admin-btn">üîë Admin Login</button>
        </div>

        <div id="admin-login-screen" class="hidden">
            <h2>Admin Panel Login</h2>
            <p>Enter the administrator password to access the quiz creation tool.</p>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Admin Password" required>
            </div>
            <button id="admin-login-btn" class="admin-btn">Login</button>
            <button id="back-to-welcome-btn" class="secondary-btn">Cancel</button>
            <p id="admin-login-feedback" class="feedback hidden"></p>
        </div>

        <div id="create-quiz-screen" class="hidden">
            <h2>Quiz Administration</h2>
            <p>Welcome, Admin! Add, manage, or delete quiz questions and categories.</p>
            
            <div id="edit-mode-indicator" class="hidden">
                EDITING QUESTION <span id="question-id-display">N/A</span>. Click "Clear Form" to add a new question.
            </div>

            <form id="add-question-form">
                
                <div class="form-group">
                    <label>Manage / Add Category</label>
                    <div class="management-container">
                        <select id="admin-category-select">
                            <option value="">-- Select Existing Category --</option>
                        </select>
                        <div class="management-buttons">
                            <button type="button" class="edit-btn" id="edit-category-btn" disabled>‚úèÔ∏è Edit</button>
                            <button type="button" class="delete-btn" id="delete-category-btn" disabled>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <input type="text" id="new-category-input" placeholder="...or Enter New Category Name">

                    <label style="margin-top: 15px;">Manage / Add Sub-Category</label>
                    <div class="management-container">
                        <select id="admin-subcategory-select" disabled>
                            <option value="">-- Select Existing Sub-Category --</option>
                        </select>
                         <div class="management-buttons">
                            <button type="button" class="edit-btn" id="edit-subcategory-btn" disabled>‚úèÔ∏è Edit</button>
                            <button type="button" class="delete-btn" id="delete-subcategory-btn" disabled>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <input type="text" id="new-subcategory-input" placeholder="...or Enter New Sub-Category Name">
                </div>
                
                <div class="form-group">
                    <label>Edit or Delete Existing Question (Filter above first)</label>
                    <div class="management-container">
                        <select id="question-select" disabled>
                            <option value="">-- Select Question to Manage --</option>
                        </select>
                        <div class="management-buttons">
                            <button type="button" class="load-btn" id="load-question-btn" disabled>Load for Edit</button>
                            <button type="button" class="delete-btn" id="delete-question-btn" disabled>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="question-text-input">Question Text</label>
                    <textarea id="question-text-input" rows="3" required placeholder="Type the quiz question here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="question-type-select">Question Type</label>
                    <select id="question-type-select" required>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="fill_in_the_blank">Fill in the Blank</option>
                        <option value="true_false">True/False</option>
                    </select>
                </div>

                <div id="multiple-choice-fields" class="type-specific-fields">
                    <label>Options (Minimum 2, check correct answer)</label>
                    <div id="mc-options-container">
                        </div>
                    <button type="button" class="secondary-btn" id="add-option-btn" style="width: auto;">+ Add Option</button>
                </div>

                <div id="fill-in-fields" class="type-specific-fields hidden">
                    <label for="fill-in-answer-input">Correct Answer (Case-insensitive match)</label>
                    <input type="text" id="fill-in-answer-input" placeholder="The single correct answer (e.g., 'cascading style sheets')">
                </div>
                
                <div id="true-false-fields" class="type-specific-fields hidden">
                    <label>Correct Answer</label>
                    <select id="tf-answer-select">
                        <option value="True">True</option>
                        <option value="False">False</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="explanation-input">Explanation/Reasoning</label>
                    <textarea id="explanation-input" rows="2" required placeholder="Explain why the answer is correct/incorrect."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="time-limit-input">Time Limit (Seconds)</label>
                    <input type="number" id="time-limit-input" value="15" min="5" required>
                </div>

                <button type="submit" class="admin-btn" id="save-question-btn" style="width: 100%; margin-top: 20px;">üíæ Add Question and Save</button>
                <button type="button" class="secondary-btn" id="clear-form-btn" style="width: 100%; margin-top: 10px;">Clear Form / New Question</button>
            </form>

            <p id="admin-feedback" class="feedback hidden"></p>
            <button id="admin-back-to-welcome-btn" class="secondary-btn" style="width: 100%; margin-top: 10px;">Exit Admin Panel</button>
        </div>


        <div id="quiz-screen" class="hidden">
            <div id="progress-indicator">Loading...</div>
            <h2 id="question-text"></h2>
            
            <div id="options-container" class="options-grid"></div>

            <input type="text" id="fill-in-input" placeholder="Type your answer here..." class="hidden">
            
            <div style="display: flex; gap: 10px;">
                <button id="submit-btn" class="main-btn">Submit Answer</button>
                <button id="skip-btn" class="secondary-btn">Skip Question</button>
            </div>
            
            <p id="feedback-message" class="feedback hidden"></p>
        </div>

        <div id="results-screen" class="hidden">
            <h2 id="results-greeting">Quiz Complete! üéâ</h2>
            <p>Name: <strong id="transcript-name"></strong></p>
            <p>Category: <strong id="transcript-category"></strong></p>
            <p>Sub-Category: <strong id="transcript-subcategory"></strong></p>

            <div id="score-circle">
                <p style="margin: 0; font-size: 0.9em;">Final Score</p>
                <span id="final-percent">0%</span>
                <p style="margin: 0; font-size: 0.9em; margin-top: 5px;">(<span id="final-score">0 / 0</span>)</p>
            </div>
            
            <p id="grade-level" style="font-weight: bold; text-align: center;">Grade: N/A</p>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="restart-btn" class="secondary-btn">Start New Quiz (Reset Name)</button>
                <button id="change-topic-btn" class="main-btn">Change Topic</button>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px; margin-bottom: 20px;">
                <button id="toggle-transcript-btn" class="secondary-btn">Show Transcript</button>
                <button id="print-transcript-btn" class="secondary-btn">üñ®Ô∏è Print Transcript</button>
            </div>

            <div id="review-area"></div>
        </div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Quiz Settings</h2>
            <p>Hello, <strong id="modal-user-name">User</strong>! Select your quiz topic.</p>
            
            <div class="selection-group">
                <label for="category-select">1. Select Main Category</label>
                <select id="category-select">
                    </select>
                
                <label for="subcategory-select">2. Select Sub-Category</label>
                <select id="subcategory-select" disabled>
                    <option value="">-- Select a Category First --</option>
                </select>

                <button id="start-quiz-btn" class="main-btn" disabled>Start Quiz</button>
            </div>
        </div>
    </div>

    <script>
        // -------------------------------------------------------------------
        // I. DATA MODEL & PERSISTENCE (MODIFIED FOR SERVER FETCH)
        // -------------------------------------------------------------------

        const DEFAULT_QUESTIONS = [
            // Note: Added timeLimit (seconds) to all default questions.
            // --- Category: Web Development, Sub-Category: CSS Basics (5 questions) ---
            { question: "Which CSS property is used to make an element's padding and border included in its total width?", type: "multiple_choice", options: ["box-shadow", "box-sizing: content-box", "box-sizing: border-box", "padding-mode"], answer: "box-sizing: border-box", explanation: "Setting 'box-sizing' to 'border-box' ensures that padding and border do not increase the element's overall dimensions.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 15, },
            { question: "What does CSS stand for?", type: "fill_in_the_blank", answer: "cascading style sheets", explanation: "CSS stands for Cascading Style Sheets.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 20, },
            { question: "The 'display: none' property hides an element but still reserves space for it. (True/False)", type: "true_false", options: ["True", "False"], answer: "False", explanation: "The 'visibility: hidden' property reserves space; 'display: none' removes the element entirely from the document flow.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 10, },
            { question: "Which value is used for a position property to fix an element relative to the browser window?", type: "multiple_choice", options: ["static", "relative", "fixed", "sticky"], answer: "fixed", explanation: "'position: fixed' keeps the element in the same place even when the page scrolls.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 15, },
            { question: "What is the CSS selector used to target all `<p>` elements inside a `<div>`?", type: "fill_in_the_blank", answer: "div p", explanation: "The descendant selector (space) targets elements inside another element.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 25, },

            // --- Category: Web Development, Sub-Category: JavaScript (5 questions) ---
            { question: "JavaScript is primarily used for styling web pages. (True/False)", type: "true_false", options: ["True", "False"], answer: "False", explanation: "JavaScript is primarily used for adding interactivity and dynamic behavior; CSS is used for styling.", category: "Web Development", subcategory: "JavaScript", timeLimit: 10, },
            { question: "What keyword declares a constant variable in JavaScript?", type: "multiple_choice", options: ["var", "let", "const", "static"], answer: "const", explanation: "The 'const' keyword is used to declare block-scoped, constant variables.", category: "Web Development", subcategory: "JavaScript", timeLimit: 15, },
            { question: "What built-in method is used to execute a function once, after a specified delay?", type: "fill_in_the_blank", answer: "settimeout", explanation: "The `setTimeout()` function executes a specified function once after the delay.", category: "Web Development", subcategory: "JavaScript", timeLimit: 20, },
            { question: "The `==` operator checks for value equality without considering data type. (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "The `==` operator performs type coercion, comparing values only. `===` checks both value and type.", category: "Web Development", subcategory: "JavaScript", timeLimit: 10, },
            { question: "Which array method adds one or more elements to the end of an array and returns the new length?", type: "multiple_choice", options: ["unshift()", "shift()", "push()", "pop()"], answer: "push()", explanation: "The `push()` method adds elements to the end of an array.", category: "Web Development", subcategory: "JavaScript", timeLimit: 15, },

            // --- Category: General Knowledge, Sub-Category: Logic (5 questions) ---
            { question: "If all A's are B's, and all B's are C's, are all A's also C's? (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "This is a basic rule of transitive logic (A=>B and B=>C implies A=>C).", category: "General Knowledge", subcategory: "Logic", timeLimit: 10, },
            { question: "What is the next number in the sequence: 1, 1, 2, 3, 5, 8, __?", type: "fill_in_the_blank", answer: "13", explanation: "This is the Fibonacci sequence, where the next number is the sum of the previous two (5 + 8 = 13).", category: "General Knowledge", subcategory: "Logic", timeLimit: 30, },
            { question: "A statement must be either true or false, but not both. (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "This is the law of excluded middle in classical logic.", category: "General Knowledge", subcategory: "Logic", timeLimit: 10, },
            { question: "If a light switch is ON, and you flip it OFF, the light is now OFF. If you flip it ON again, the light is ON. This is an example of what type of relationship?", type: "multiple_choice", options: ["Inverse relationship", "Direct cause and effect", "Contingency", "Non-linear system"], answer: "Direct cause and effect", explanation: "The state of the light is directly determined by the state of the switch.", category: "General Knowledge", subcategory: "Logic", timeLimit: 15, },
            { question: "An argument that is both valid and has true premises is considered what?", type: "fill_in_the_blank", answer: "sound", explanation: "A 'sound' argument is a valid argument with true premises; a 'valid' argument means the conclusion follows logically from the premises.", category: "General Knowledge", subcategory: "Logic", timeLimit: 20, },

            // --- Category: General Knowledge, Sub-Category: Tech History (5 questions) ---
            { question: "Which color is typically associated with successful execution status?", type: "multiple_choice", options: ["Blue", "Red", "Green", "Yellow"], answer: "Green", explanation: "Green (success) and Red (error) are common UI color codes.", category: "General Knowledge", subcategory: "Tech History", timeLimit: 10, },
            { question: "Who co-founded Microsoft with Bill Gates?", type: "fill_in_the_blank", answer: "paul allen", explanation: "Paul Allen co-founded Microsoft with Bill Gates in 1975.", category: "General Knowledge", subcategory: "Tech History", timeLimit: 20, },
            { question: "The first mechanical computer was designed by Charles Babbage. (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "Charles Babbage is credited with conceptualizing and designing the first mechanical computers, the Difference Engine and the Analytical Engine.", category: "General Knowledge", subcategory: "Tech History", timeLimit: 15, },
            { question: "What was the first commercially successful personal computer with a graphical user interface (GUI)?", type: "multiple_choice", options: ["IBM PC", "Apple Lisa", "Xerox Alto", "Commodore 64"], answer: "Apple Lisa", explanation: "While the Xerox Alto was the first computer with a GUI, the Apple Lisa (1983) was the first commercially released personal computer that focused on the GUI concept.", category: "General Knowledge", subcategory: "Tech History", timeLimit: 15, },
            { question: "In what year was the World Wide Web invented?", type: "fill_in_the_blank", answer: "1989", explanation: "Tim Berners-Lee invented the World Wide Web in 1989 while working at CERN.", category: "General Knowledge", subcategory: "Tech History", timeLimit: 20, },
        ];
        
        const ADMIN_PASSWORD = "admin1234"; 
        const ADMIN_ENABLED = true; 
        
        // This will be initialized asynchronously by initializeApp()
        let ALL_QUESTIONS = []; 

        /**
         * Loads questions from server file or falls back to defaults.
         * @returns {Array} Array of question objects.
         */
        async function loadAllQuestions() { 
            try {
                // Fetch data from the new Express endpoint
                const response = await fetch('http://localhost:3000/api/questions/load'); 
                if (!response.ok) throw new Error('Failed to load questions from server.');
                
                const remoteQuestions = await response.json();
                
                // If the remote file is empty, use the hardcoded defaults
                if (remoteQuestions.length > 0) {
                     console.log(`Loaded ${remoteQuestions.length} questions from server file.`);
                     return remoteQuestions;
                }
                
            } catch (error) {
                console.error("Could not load questions from server. Falling back to default data.", error);
            }
            // Fallback to the hardcoded default questions
            console.log(`Falling back to ${DEFAULT_QUESTIONS.length} default questions.`);
            return DEFAULT_QUESTIONS;
        }

        /**
         * Saves the current ALL_QUESTIONS array to the server file.
         */
        async function saveQuestionsToRemoteFile() { 
            try {
                const response = await fetch('http://localhost:3000/api/questions/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ALL_QUESTIONS)
                });

                if (!response.ok) throw new Error('Failed to save data to server.');

                const result = await response.json();
                console.log(`Server save successful: ${result.message}`);
            } catch (error) {
                console.error("Error saving questions to remote file:", error);
                alert("CRITICAL ERROR: Data could not be saved to the server. Check server console for errors.");
            }
        }


        // Helper function to derive categories (must be called after ALL_QUESTIONS is updated)
        function getCategories() {
            return [...new Set(ALL_QUESTIONS.map(q => q.category))];
        }
        
        function getSubcategories(category) {
            return [...new Set(ALL_QUESTIONS
                .filter(q => q.category === category)
                .map(q => q.subcategory))];
        }


        // -------------------------------------------------------------------
        // II. GLOBAL STATE & DOM ELEMENTS
        // -------------------------------------------------------------------

        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizTimer;
        // const TIME_PER_QUESTION = 15; // Removed: Now dynamically set per question
        let userAttempts = [];
        let selectedCategory = '';
        let selectedSubcategory = '';
        let userName = ''; 
        
        // --- NEW ADMIN STATE ---
        let questionIndexToEdit = -1; // -1 means adding new question

        const DOM = {
            container: document.querySelector('.quiz-container'),
            welcomeScreen: document.getElementById('welcome-screen'),
            userNameInput: document.getElementById('user-name-input'),
            proceedToSettingsBtn: document.getElementById('proceed-to-settings-btn'), 
            showAdminLoginBtn: document.getElementById('show-admin-login-btn'), 
            
            // Admin Login Elements
            adminLoginScreen: document.getElementById('admin-login-screen'),
            adminPasswordInput: document.getElementById('admin-password'),
            adminLoginBtn: document.getElementById('admin-login-btn'),
            backToWelcomeBtn: document.getElementById('back-to-welcome-btn'),
            adminLoginFeedback: document.getElementById('admin-login-feedback'),

            // Admin Create Quiz Elements
            createQuizScreen: document.getElementById('create-quiz-screen'),
            addQuestionForm: document.getElementById('add-question-form'),
            editModeIndicator: document.getElementById('edit-mode-indicator'), // NEW
            questionIdDisplay: document.getElementById('question-id-display'), // NEW
            saveQuestionBtn: document.getElementById('save-question-btn'), // NEW: Renamed from add-question-btn
            clearFormBtn: document.getElementById('clear-form-btn'), // NEW

            // Category Management
            adminCategorySelect: document.getElementById('admin-category-select'),
            newCategoryInput: document.getElementById('new-category-input'),
            editCategoryBtn: document.getElementById('edit-category-btn'), 
            deleteCategoryBtn: document.getElementById('delete-category-btn'), 
            adminSubcategorySelect: document.getElementById('admin-subcategory-select'),
            newSubcategoryInput: document.getElementById('new-subcategory-input'),
            editSubcategoryBtn: document.getElementById('edit-subcategory-btn'), 
            deleteSubcategoryBtn: document.getElementById('delete-subcategory-btn'), 
            
            // Question Management (NEW)
            questionSelect: document.getElementById('question-select'),
            loadQuestionBtn: document.getElementById('load-question-btn'),
            deleteQuestionBtn: document.getElementById('delete-question-btn'),

            // Question Fields
            questionTextInput: document.getElementById('question-text-input'),
            questionTypeSelect: document.getElementById('question-type-select'),
            multipleChoiceFields: document.getElementById('multiple-choice-fields'),
            mcOptionsContainer: document.getElementById('mc-options-container'),
            addOptionBtn: document.getElementById('add-option-btn'),
            fillInFields: document.getElementById('fill-in-fields'),
            fillInAnswerInput: document.getElementById('fill-in-answer-input'),
            trueFalseFields: document.getElementById('true-false-fields'),
            tfAnswerSelect: document.getElementById('tf-answer-select'),
            explanationInput: document.getElementById('explanation-input'),
            
            // NEW DOM ELEMENT FOR TIME LIMIT
            timeLimitInput: document.getElementById('time-limit-input'), 
            
            adminFeedback: document.getElementById('admin-feedback'),
            adminBackToWelcomeBtn: document.getElementById('admin-back-to-welcome-btn'),


            // Modal Elements
            settingsModalOverlay: document.getElementById('settings-modal-overlay'), 
            modalUserName: document.getElementById('modal-user-name'),              
            categorySelect: document.getElementById('category-select'),
            subcategorySelect: document.getElementById('subcategory-select'),
            startQuizBtn: document.getElementById('start-quiz-btn'),

            quizScreen: document.getElementById('quiz-screen'),
            resultsScreen: document.getElementById('results-screen'),
            themeToggle: document.getElementById('theme-toggle'),
            timeDisplay: document.getElementById('time'),
            cancelQuizBtn: document.getElementById('cancel-quiz-btn'),
            progressIndicator: document.getElementById('progress-indicator'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            fillInInput: document.getElementById('fill-in-input'),
            submitBtn: document.getElementById('submit-btn'),
            skipBtn: document.getElementById('skip-btn'),
            feedbackMessage: document.getElementById('feedback-message'),
            finalScore: document.getElementById('final-score'),
            finalPercent: document.getElementById('final-percent'),
            gradeLevel: document.getElementById('grade-level'),
            reviewArea: document.getElementById('review-area'),
            restartBtn: document.getElementById('restart-btn'),
            changeTopicBtn: document.getElementById('change-topic-btn'), 
            toggleTranscriptBtn: document.getElementById('toggle-transcript-btn'),
            printTranscriptBtn: document.getElementById('print-transcript-btn'),
            resultsGreeting: document.getElementById('results-greeting'),
            transcriptName: document.getElementById('transcript-name'),
            transcriptCategory: document.getElementById('transcript-category'),
            transcriptSubcategory: document.getElementById('transcript-subcategory'),
            scoreCircle: document.getElementById('score-circle') 
        };


        // -------------------------------------------------------------------
        // III. UTILITY FUNCTIONS
        // -------------------------------------------------------------------

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(RNG() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // Use Math.random() directly for simplicity and robustness in this non-cryptographic context
        function RNG() {
            return Math.random(); 
        }

        function showScreen(screenId) {
            DOM.welcomeScreen.classList.add('hidden');
            DOM.quizScreen.classList.add('hidden');
            DOM.resultsScreen.classList.add('hidden');
            DOM.settingsModalOverlay.classList.add('hidden'); 
            DOM.adminLoginScreen.classList.add('hidden'); 
            DOM.createQuizScreen.classList.add('hidden'); 
            
            DOM.cancelQuizBtn.classList.add('hidden');
            
            if (screenId === 'welcome') {
                DOM.welcomeScreen.classList.remove('hidden');
                DOM.cancelQuizBtn.textContent = '‚ùå Cancel Quiz';
            } else if (screenId === 'quiz') {
                DOM.quizScreen.classList.remove('hidden');
                DOM.cancelQuizBtn.classList.remove('hidden');
                DOM.cancelQuizBtn.textContent = '‚ùå Cancel Quiz';
            } else if (screenId === 'results') {
                DOM.resultsScreen.classList.remove('hidden');
            } else if (screenId === 'admin_login') { 
                DOM.adminLoginScreen.classList.remove('hidden');
                DOM.cancelQuizBtn.classList.remove('hidden');
                DOM.cancelQuizBtn.textContent = '‚ùå Back';
            } else if (screenId === 'admin_panel') { 
                DOM.createQuizScreen.classList.remove('hidden');
            }
        }
        
        /**
         * Checks if the name input is valid to enable the proceed button.
         */
        function checkNameInput() {
            userName = DOM.userNameInput.value.trim();
            const nameValid = userName.length > 1;
            DOM.proceedToSettingsBtn.disabled = !nameValid;
        }

        /**
         * Checks if the name and selections are valid to enable the start button in the modal.
         */
        function checkReadyToStart() {
            const categorySelected = DOM.categorySelect.value !== '';
            const subcategorySelected = DOM.subcategorySelect.value !== '';
            
            DOM.startQuizBtn.disabled = !(categorySelected && subcategorySelected);
        }

        // -------------------------------------------------------------------
        // IV. QUIZ FLOW CONTROL
        // -------------------------------------------------------------------

        /**
         * Initializes the Welcome Screen (Name Input).
         */
        function initWelcome() {
            showScreen('welcome');
            clearInterval(quizTimer);
            DOM.timeDisplay.textContent = 'N/A';
            
            // --- Admin Visibility Control ---
            if (ADMIN_ENABLED) {
                DOM.showAdminLoginBtn.classList.remove('hidden');
            } else {
                DOM.showAdminLoginBtn.classList.add('hidden');
            }
            // -----------------------------------

            // Clear name if coming from "Start New Quiz (Reset Name)"
            if (userName === 'RESET_NAME') {
                 userName = '';
                 DOM.userNameInput.value = '';
            } else {
                 DOM.userNameInput.value = userName; 
            }
            
            // Reset modal selections 
            DOM.categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
            DOM.subcategorySelect.innerHTML = '<option value="">-- Select a Category First --</option>';
            DOM.subcategorySelect.disabled = true;
            
            selectedCategory = '';
            selectedSubcategory = '';

            checkNameInput(); 
        }

        /**
         * Shows the modal and populates the categories.
         */
        function showSettingsModal(resetSelections = true) { 
            if (userName.length <= 1) {
                alert("Please enter a valid name.");
                return;
            }

            DOM.modalUserName.textContent = userName;
            DOM.settingsModalOverlay.classList.remove('hidden');
            
            // 1. Populate Main Category Dropdown
            DOM.categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
            getCategories().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                DOM.categorySelect.appendChild(option);
            });
            
            if (resetSelections) {
                // Force a full reset of selection in modal if coming from 'Proceed' or 'Change Topic'
                DOM.categorySelect.value = '';
                DOM.subcategorySelect.innerHTML = '<option value="">-- Select a Category First --</option>';
                DOM.subcategorySelect.disabled = true;
            }
            
            checkReadyToStart();
        }
        
        /**
         * Populates the Sub-Category Dropdown based on the selected main category.
         */
        function populateSubcategories() {
            selectedCategory = DOM.categorySelect.value;
            DOM.subcategorySelect.innerHTML = '';
            
            if (selectedCategory === '') {
                DOM.subcategorySelect.innerHTML = '<option value="">-- Select a Category First --</option>';
                DOM.subcategorySelect.disabled = true;
            } else {
                DOM.subcategorySelect.disabled = false;
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select Sub-Category --';
                DOM.subcategorySelect.appendChild(defaultOption);

                // Filter all questions to find unique subcategories for the selected category
                getSubcategories(selectedCategory).forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    DOM.subcategorySelect.appendChild(option);
                });
            }
            // Check readiness again after updating subcategories
            DOM.subcategorySelect.value = ''; 
            checkReadyToStart();
        }

        /**
         * Handles starting the quiz from the modal.
         */
        function handleStartQuiz() {
            if (!DOM.startQuizBtn.disabled) {
                selectedSubcategory = DOM.subcategorySelect.value;
                startQuiz();
            } else {
                alert("Please select both a Category and a Sub-Category.");
            }
        }

        /**
         * Starts the quiz execution.
         */
        function startQuiz() {
            // Filter questions by BOTH category and subcategory
            currentQuestions = ALL_QUESTIONS.filter(q => q.category === selectedCategory && q.subcategory === selectedSubcategory);
            shuffleArray(currentQuestions);
            
            if (currentQuestions.length === 0) {
                 alert(`No questions found for the sub-category: ${selectedSubcategory}. Please choose another.`);
                 return;
            }

            currentQuestionIndex = 0;
            score = 0;
            userAttempts = [];

            showScreen('quiz');
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                return showResults();
            }

            const currentQ = currentQuestions[currentQuestionIndex];
            
            clearInterval(quizTimer);
            DOM.optionsContainer.innerHTML = '';
            DOM.feedbackMessage.classList.add('hidden');
            DOM.submitBtn.disabled = false;
            DOM.skipBtn.disabled = false;
            DOM.fillInInput.classList.add('hidden');
            DOM.fillInInput.value = '';
            
            // Update Progress Indicator
            DOM.progressIndicator.textContent = `Question ${currentQuestionIndex + 1} of ${currentQuestions.length} (${selectedCategory}: ${selectedSubcategory})`;
            DOM.questionText.textContent = currentQ.question;
            
            DOM.submitBtn.classList.remove('hidden');
            DOM.skipBtn.classList.remove('hidden');

            if (currentQ.type === 'multiple_choice' || currentQ.type === 'true_false' || currentQ.type === 'image_based') {
                DOM.optionsContainer.classList.remove('hidden');
                
                let optionsToDisplay = [...currentQ.options];
                shuffleArray(optionsToDisplay);

                optionsToDisplay.forEach(optionText => {
                    const button = document.createElement('button');
                    button.classList.add('option-btn');
                    button.textContent = optionText;
                    button.onclick = () => selectOption(button, optionText);
                    DOM.optionsContainer.appendChild(button);
                });
            } else if (currentQ.type === 'fill_in_the_blank') {
                DOM.optionsContainer.classList.add('hidden');
                DOM.fillInInput.classList.remove('hidden');
            }

            startTimer();
        }
        
        function selectOption(selectedButton, selectedAnswer) {
            document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
            selectedButton.classList.add('selected');
            
            checkAnswer(selectedAnswer, selectedButton);
        }

        function handleSubmit() {
            const currentQ = currentQuestions[currentQuestionIndex];
            if (currentQ.type === 'fill_in_the_blank') {
                const userAnswer = DOM.fillInInput.value.trim().toLowerCase();
                if (userAnswer) {
                    checkAnswer(userAnswer);
                } else {
                    alert("Please type your answer.");
                }
            }
        }
        
        function skipQuestion() {
            clearInterval(quizTimer);
            const currentQ = currentQuestions[currentQuestionIndex];
            
            userAttempts.push({
                question: currentQ.question,
                userAnswer: 'SKIPPED',
                correctAnswer: currentQ.answer,
                isCorrect: false,
                explanation: currentQ.explanation
            });

            DOM.feedbackMessage.className = 'feedback incorrect-msg';
            DOM.feedbackMessage.textContent = `‚è≠Ô∏è Question Skipped. The answer was: ${currentQ.answer}`;
            DOM.feedbackMessage.classList.remove('hidden');
            
            DOM.submitBtn.disabled = true;
            DOM.skipBtn.disabled = true;
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }


        function checkAnswer(userAnswer, selectedElement = null) {
            clearInterval(quizTimer);
            DOM.submitBtn.disabled = true;
            DOM.skipBtn.disabled = true;
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            
            const currentQ = currentQuestions[currentQuestionIndex];
            const correctAnswer = String(currentQ.answer).trim().toLowerCase();
            const submittedAnswer = String(userAnswer).trim().toLowerCase();
            
            const isCorrect = submittedAnswer === correctAnswer;

            if (isCorrect) {
                score++;
                DOM.feedbackMessage.className = 'feedback correct-msg';
                DOM.feedbackMessage.textContent = '‚úÖ Correct! ' + currentQ.explanation;
            } else {
                DOM.feedbackMessage.className = 'feedback incorrect-msg';
                DOM.feedbackMessage.textContent = `‚ùå Incorrect. The answer was: ${currentQ.answer}. ${currentQ.explanation}`;
            }

            if (selectedElement) {
                selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                     document.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.textContent.trim().toLowerCase() === correctAnswer) {
                            btn.style.borderColor = 'var(--success-color)';
                            btn.style.fontWeight = 'bold';
                        }
                    });
                }
            }

            userAttempts.push({
                question: currentQ.question,
                userAnswer: userAnswer === 'TIME_OUT' ? '(Time Out)' : userAnswer,
                correctAnswer: currentQ.answer,
                isCorrect: isCorrect,
                explanation: currentQ.explanation
            });

            DOM.feedbackMessage.classList.remove('hidden');

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 3000);
        }

        function startTimer() {
            const currentQ = currentQuestions[currentQuestionIndex];
            // Read the timeLimit from the current question, falling back to 15 seconds if missing
            const timeLimit = currentQ.timeLimit || 15; 
            
            let timeLeft = timeLimit; 
            DOM.timeDisplay.textContent = timeLeft;
            
            quizTimer = setInterval(() => {
                timeLeft--;
                DOM.timeDisplay.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    checkAnswer("TIME_OUT"); 
                }
            }, 1000);
        }

        function showResults() {
            clearInterval(quizTimer);
            DOM.timeDisplay.textContent = 'Finished';

            showScreen('results');

            const totalQuestionsAnswered = userAttempts.length;
            const percentage = totalQuestionsAnswered > 0 ? Math.round((score / totalQuestionsAnswered) * 100) : 0;

            // Update Transcript Info
            DOM.resultsGreeting.textContent = `Quiz Complete, ${userName}! üéâ`;
            DOM.transcriptName.textContent = userName;
            DOM.transcriptCategory.textContent = selectedCategory;
            DOM.transcriptSubcategory.textContent = selectedSubcategory;

            // Update Results Summary
            DOM.finalScore.textContent = `${score} / ${totalQuestionsAnswered}`;
            DOM.finalPercent.textContent = `${percentage}%`;
            DOM.gradeLevel.textContent = calculateGrade(percentage);

            // --- Dynamic Score Styling Logic ---
            DOM.scoreCircle.classList.remove('score-green', 'score-orange', 'score-red');
            DOM.finalPercent.classList.remove('score-green', 'score-orange', 'score-red');

            if (percentage >= 80) {
                DOM.scoreCircle.classList.add('score-green');
                DOM.finalPercent.classList.add('score-green');
            } else if (percentage >= 60) {
                DOM.scoreCircle.classList.add('score-orange');
                DOM.finalPercent.classList.add('score-orange');
            } else {
                DOM.scoreCircle.classList.add('score-red');
                DOM.finalPercent.classList.add('score-red');
            }
            // --------------------------------------------------

            renderReviewArea();
            
            // By default, HIDE the transcript and set the button state to SHOW
            DOM.reviewArea.classList.add('hidden'); 
            DOM.toggleTranscriptBtn.textContent = 'Show Transcript'; 
        }

        function calculateGrade(percent) {
            if (percent >= 90) return 'A+ (Excellent)';
            if (percent >= 80) return 'A (Great)';
            if (percent >= 70) return 'B (Good)';
            if (percent >= 60) return 'C (Average)';
            return 'F (Needs Practice)';
        }
        
        function renderReviewArea() {
            DOM.reviewArea.innerHTML = '<h3>Review Transcript</h3>';
            userAttempts.forEach((attempt, index) => {
                const item = document.createElement('div');
                item.classList.add('review-item');
                item.style.marginBottom = '20px';
                item.style.padding = '10px';
                item.style.borderRadius = '5px';
                
                const statusColor = attempt.isCorrect ? 'var(--success-color)' : (attempt.userAnswer === 'SKIPPED' ? 'gray' : 'var(--error-color)');
                
                item.style.borderLeft = `5px solid ${statusColor}`;
                
                item.innerHTML = `
                    <p><strong>Q${index + 1} (${attempt.isCorrect ? 'Correct' : attempt.userAnswer === 'SKIPPED' ? 'Skipped' : 'Incorrect'}): ${attempt.question}</strong></p>
                    <p>Your Response: <span style="font-style: italic; color: ${statusColor}">${attempt.userAnswer}</span></p>
                    <p>Correct Answer: <strong>${attempt.correctAnswer}</strong></p>
                    <p>Explanation: ${attempt.explanation}</p>
                    <hr>
                `;
                DOM.reviewArea.appendChild(item);
            });
        }
        
        /**
         * Toggles the visibility of the review/transcript area.
         */
        function toggleTranscript() {
            const isHidden = DOM.reviewArea.classList.toggle('hidden');
            DOM.toggleTranscriptBtn.textContent = isHidden ? 'Show Transcript' : 'Hide Transcript';
        }

        function cancelQuiz() {
            if (DOM.quizScreen.classList.contains('hidden')) {
                // If not in quiz, just go back to welcome
                 initWelcome();
            }
            else if (confirm("Are you sure you want to cancel this quiz? Your progress will be lost.")) {
                clearInterval(quizTimer);
                initWelcome();
            }
        }
        
        function printTranscript() {
            window.print();
        }
        
        /**
         * Resets state and sends user back to the initial Welcome screen to re-enter their name.
         */
        function resetAndGoToWelcome() {
             userName = 'RESET_NAME'; // Flag to tell initWelcome to clear the input
             initWelcome();
        }


        // -------------------------------------------------------------------
        // V. ADMIN PANEL LOGIC 
        // -------------------------------------------------------------------

        function handleAdminLogin() {
            const password = DOM.adminPasswordInput.value;
            DOM.adminLoginFeedback.classList.add('hidden');

            if (password === ADMIN_PASSWORD) {
                showAdminPanel();
            } else {
                DOM.adminLoginFeedback.className = 'feedback incorrect-msg';
                DOM.adminLoginFeedback.textContent = '‚ùå Invalid password.';
                DOM.adminLoginFeedback.classList.remove('hidden');
            }
            DOM.adminPasswordInput.value = '';
        }

        function showAdminPanel() {
            showScreen('admin_panel');
            resetAdminForm(); // Set initial state
            populateAdminCategorySelect();
            handleQuestionTypeChange();
        }
        
        /**
         * Resets the main question form and switches to Add New Question mode.
         */
        function resetAdminForm() {
            questionIndexToEdit = -1; // Switch to ADD mode
            DOM.addQuestionForm.reset();
            DOM.editModeIndicator.classList.add('hidden');
            DOM.saveQuestionBtn.textContent = 'üíæ Add Question and Save';
            DOM.questionIdDisplay.textContent = 'N/A';
            
            // NEW: Reset Time Limit input
            DOM.timeLimitInput.value = 15;
            
            // Clear selections in the question management dropdowns
            DOM.questionSelect.innerHTML = '<option value="">-- Select Question to Manage --</option>';
            // Ensure buttons are disabled initially
            DOM.loadQuestionBtn.disabled = true;
            DOM.deleteQuestionBtn.disabled = true;
            DOM.questionSelect.disabled = true;
            
            handleQuestionTypeChange(); // Reset option fields
            renderMCOptions(2); // Start with 2 options
            displayAdminFeedback('Admin Panel ready to add a new question.', 'correct-msg');

            // Re-populate category/subcategory selects and trigger dependency chain
            populateAdminCategorySelect();
        }

        function populateAdminCategorySelect() {
            // Clear existing options
            const currentCat = DOM.adminCategorySelect.value;
            DOM.adminCategorySelect.innerHTML = '<option value="">-- Select Existing Category --</option>';
            
            const categories = getCategories();
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                DOM.adminCategorySelect.appendChild(option);
            });
            
            // Attempt to restore selection
            if (categories.includes(currentCat)) {
                DOM.adminCategorySelect.value = currentCat;
            } else {
                DOM.adminCategorySelect.value = '';
            }

            // Clear new category input
            DOM.newCategoryInput.value = '';
            // Reset button states and chain to subcategory population
            updateCategoryManagementButtons();

            populateAdminSubcategorySelect();
        }
        
        function populateAdminSubcategorySelect() {
            const category = DOM.adminCategorySelect.value;
            const currentSubcat = DOM.adminSubcategorySelect.value;
            
            DOM.adminSubcategorySelect.innerHTML = '<option value="">-- Select Existing Sub-Category --</option>';
            
            if (category) {
                 const subcategories = getSubcategories(category);
                 subcategories.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    DOM.adminSubcategorySelect.appendChild(option);
                });
                
                // Attempt to restore selection
                if (subcategories.includes(currentSubcat)) {
                    DOM.adminSubcategorySelect.value = currentSubcat;
                } else {
                    DOM.adminSubcategorySelect.value = '';
                }
            }

            // Clear new subcategory input
            DOM.newSubcategoryInput.value = '';
            // 1. Reset button states and chain to question population
            updateCategoryManagementButtons(); 
            
            // 2. Ensure question list populates correctly
            populateQuestionSelect();
        }
        
        /**
         * Enables/disables all admin control buttons based on selections/inputs.
         */
        function updateCategoryManagementButtons() {
            const selectedCat = DOM.adminCategorySelect.value;
            const newCatValue = DOM.newCategoryInput.value.trim();
            const selectedSubcat = DOM.adminSubcategorySelect.value;
            const newSubcatValue = DOM.newSubcategoryInput.value.trim();

            // 1. Control Category Inputs
            DOM.editCategoryBtn.disabled = !selectedCat;
            DOM.deleteCategoryBtn.disabled = !selectedCat;
            DOM.newCategoryInput.disabled = !!selectedCat;
            DOM.adminCategorySelect.disabled = newCatValue !== '';

            // 2. Control Subcategory Inputs
            const categoryIsDefined = !!selectedCat || newCatValue !== '';
            
            // Subcategory dropdown is disabled if no category is selected or being typed, OR if a new subcategory is being typed.
            DOM.adminSubcategorySelect.disabled = !categoryIsDefined || newSubcatValue !== '';
            
            // Buttons activate when a selection is made
            DOM.editSubcategoryBtn.disabled = !selectedSubcat; 
            DOM.deleteSubcategoryBtn.disabled = !selectedSubcat;
            DOM.newSubcategoryInput.disabled = !!selectedSubcat;

            // CRITICAL: Force question select update if the filter is set via input text
            if (categoryIsDefined && (!!selectedSubcat || newSubcatValue)) {
                 populateQuestionSelect();
            } else {
                 // Explicitly disable the question select if filter is not complete
                 DOM.questionSelect.disabled = true;
                 updateQuestionManagementButtons();
            }
        }

        // --- Question Management Functions ---

        function populateQuestionSelect() {
            const category = DOM.adminCategorySelect.value;
            const subcategory = DOM.adminSubcategorySelect.value;
            
            // 1. Reset dropdown and set default option
            DOM.questionSelect.innerHTML = '<option value="">-- Select Question to Manage --</option>';

            // 2. Check if the filtering criteria is met (must select category AND subcategory)
            if (!category || !subcategory) {
                DOM.questionSelect.disabled = true;
                updateQuestionManagementButtons(); 
                return;
            }
            
            DOM.questionSelect.disabled = false;

            // 3. Populate questions
            let questionsFound = false;
            ALL_QUESTIONS.forEach((q, index) => {
                if (q.category === category && q.subcategory === subcategory) {
                    const option = document.createElement('option');
                    // Store the index in the ALL_QUESTIONS array in the value
                    option.value = index; 
                    option.textContent = `Q${index+1} (${q.timeLimit}s): ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}`;
                    DOM.questionSelect.appendChild(option);
                    questionsFound = true;
                }
            });
            
            // 4. If no questions found, disable the select
            if (!questionsFound) {
                 DOM.questionSelect.disabled = true;
            }

            // 5. Update buttons based on the new state
            updateQuestionManagementButtons();
        }
        
        function updateQuestionManagementButtons() {
            // Check if the selected value is a valid index (not the default empty string)
            const questionSelected = DOM.questionSelect.value !== ''; 
            
            // Check if the dropdown itself is currently disabled 
            const isSelectDisabled = DOM.questionSelect.disabled;

            // Buttons are enabled only if a valid question is selected AND the select is NOT disabled.
            DOM.loadQuestionBtn.disabled = !questionSelected || isSelectDisabled;
            DOM.deleteQuestionBtn.disabled = !questionSelected || isSelectDisabled;
        }

        async function loadQuestionForEdit() {
            // Check if a question is actually selected before parsing
            if (DOM.questionSelect.value === '' || DOM.questionSelect.disabled) {
                 displayAdminFeedback('Please select a question to load.', 'incorrect-msg');
                 return;
            }
            
            const index = parseInt(DOM.questionSelect.value);
            if (isNaN(index) || index < 0 || index >= ALL_QUESTIONS.length) {
                 displayAdminFeedback('Invalid question index selected.', 'incorrect-msg');
                 return;
            }

            const question = ALL_QUESTIONS[index];
            questionIndexToEdit = index; // Set index for UPDATE mode

            // 1. Update Mode Indicator
            DOM.editModeIndicator.classList.remove('hidden');
            DOM.questionIdDisplay.textContent = index + 1;
            DOM.saveQuestionBtn.textContent = 'üîÑ Update Question and Save';
            
            // 2. Populate Form Fields
            DOM.questionTextInput.value = question.question;
            DOM.questionTypeSelect.value = question.type;
            DOM.explanationInput.value = question.explanation;
            
            // NEW: Populate Time Limit field, defaulting to 15 if not set
            DOM.timeLimitInput.value = question.timeLimit || 15; 
            
            handleQuestionTypeChange(); // Show/hide fields based on type
            
            // 3. Populate Type-Specific Fields
            if (question.type === 'multiple_choice') {
                renderMCOptions(question.options.length);
                question.options.forEach((optionText, i) => {
                    // Find the input and radio button by ID
                    const input = DOM.mcOptionsContainer.querySelector(`#mc-option-${i}`).previousElementSibling;
                    const radio = DOM.mcOptionsContainer.querySelector(`#mc-option-${i}`);
                    
                    if (input && radio) { // Safety check
                        input.value = optionText;
                        if (optionText === question.answer) {
                            radio.checked = true;
                        }
                    }
                });
            } else if (question.type === 'fill_in_the_blank') {
                DOM.fillInAnswerInput.value = question.answer;
            } else if (question.type === 'true_false') {
                DOM.tfAnswerSelect.value = question.answer;
            }
            
            displayAdminFeedback(`Question ${index + 1} loaded for editing.`, 'edit-btn');
        }
        
        async function deleteQuestion() {
            // Check if a question is actually selected before parsing
            if (DOM.questionSelect.value === '' || DOM.questionSelect.disabled) {
                 displayAdminFeedback('Please select a question to delete.', 'incorrect-msg');
                 return; 
            }

            const index = parseInt(DOM.questionSelect.value);
            if (isNaN(index) || index < 0 || index >= ALL_QUESTIONS.length) {
                 displayAdminFeedback('Invalid question index selected for deletion.', 'incorrect-msg');
                 return;
            }

            const question = ALL_QUESTIONS[index];
            
            if (confirm(`Are you sure you want to permanently DELETE question ${index + 1}: "${question.question.substring(0, 50)}..."?`)) {
                // Remove the question from the array
                ALL_QUESTIONS.splice(index, 1);
                await saveQuestionsToRemoteFile(); // *** SERVER PERSISTENCE ***
                displayAdminFeedback(`üóëÔ∏è Question ${index + 1} deleted successfully! Total questions: ${ALL_QUESTIONS.length}`, 'incorrect-msg');
                resetAdminForm(); // Reset form state and refresh selects
            }
        }

        // --- Category Management Functions ---
        
        /**
         * Handles deletion of a Category or Subcategory and all associated questions.
         * @param {string} type 'category' or 'subcategory'
         */
        async function deleteCategoryOrSubcategory(type) {
            DOM.adminFeedback.classList.add('hidden');
            let valueToDelete;
            let questionsDeletedCount;
            let confirmationMessage;

            if (type === 'category') {
                valueToDelete = DOM.adminCategorySelect.value;
                if (!valueToDelete) return;

                questionsDeletedCount = ALL_QUESTIONS.filter(q => q.category === valueToDelete).length;
                confirmationMessage = `Are you sure you want to delete the CATEGORY: "${valueToDelete}"? This will permanently delete ${questionsDeletedCount} questions.`;

                if (confirm(confirmationMessage)) {
                    ALL_QUESTIONS = ALL_QUESTIONS.filter(q => q.category !== valueToDelete);
                    displayAdminFeedback(`üóëÔ∏è CATEGORY deleted: "${valueToDelete}". ${questionsDeletedCount} questions removed.`, 'correct-msg');
                } else {
                    return;
                }

            } else if (type === 'subcategory') {
                const category = DOM.adminCategorySelect.value;
                valueToDelete = DOM.adminSubcategorySelect.value;
                if (!category || !valueToDelete) return;

                questionsDeletedCount = ALL_QUESTIONS.filter(q => q.category === category && q.subcategory === valueToDelete).length;
                confirmationMessage = `Are you sure you want to delete the SUB-CATEGORY: "${valueToDelete}" under "${category}"? This will permanently delete ${questionsDeletedCount} questions.`;

                if (confirm(confirmationMessage)) {
                    ALL_QUESTIONS = ALL_QUESTIONS.filter(q => !(q.category === category && q.subcategory === valueToDelete));
                    displayAdminFeedback(`üóëÔ∏è SUB-CATEGORY deleted: "${valueToDelete}" under "${category}". ${questionsDeletedCount} questions removed.`, 'correct-msg');
                } else {
                    return;
                }
            }
            
            await saveQuestionsToRemoteFile(); // *** SERVER PERSISTENCE ***
            resetAdminForm(); // Reset form and selects

        }

        /**
         * Handles editing/renaming of a Category or Subcategory.
         * @param {string} type 'category' or 'subcategory'
         */
        async function editCategoryOrSubcategory(type) {
            DOM.adminFeedback.classList.add('hidden');
            let oldValue, newValue;
            let successMessage;

            if (type === 'category') {
                oldValue = DOM.adminCategorySelect.value;
                if (!oldValue) return;

                newValue = prompt(`Rename CATEGORY "${oldValue}" to:`, oldValue);
                if (!newValue || newValue.trim() === oldValue) {
                    displayAdminFeedback('Category name change cancelled or name is identical.', 'incorrect-msg');
                    return;
                }
                
                newValue = newValue.trim();
                successMessage = `‚úèÔ∏è CATEGORY renamed from "${oldValue}" to "${newValue}".`;

                // Update all questions
                ALL_QUESTIONS.forEach(q => {
                    if (q.category === oldValue) {
                        q.category = newValue;
                    }
                });
                
            } else if (type === 'subcategory') {
                const category = DOM.adminCategorySelect.value;
                oldValue = DOM.adminSubcategorySelect.value;
                if (!category || !oldValue) return;

                newValue = prompt(`Rename SUB-CATEGORY "${oldValue}" under "${category}" to:`, oldValue);
                if (!newValue || newValue.trim() === oldValue) {
                    displayAdminFeedback('Sub-Category name change cancelled or name is identical.', 'incorrect-msg');
                    return;
                }
                
                newValue = newValue.trim();
                successMessage = `‚úèÔ∏è SUB-CATEGORY renamed from "${oldValue}" to "${newValue}" under "${category}".`;

                // Update all questions
                ALL_QUESTIONS.forEach(q => {
                    if (q.category === category && q.subcategory === oldValue) {
                        q.subcategory = newValue;
                    }
                });
            }

            await saveQuestionsToRemoteFile(); // *** SERVER PERSISTENCE ***
            resetAdminForm(); // Reset form and selects to refresh UI with new names
            displayAdminFeedback(successMessage, 'correct-msg');
        }

        // --- Question Form Logic ---

        function handleQuestionTypeChange() {
            const type = DOM.questionTypeSelect.value;
            DOM.multipleChoiceFields.classList.add('hidden');
            DOM.fillInFields.classList.add('hidden');
            DOM.trueFalseFields.classList.add('hidden');
            
            // Reset required attributes on all potential inputs to prevent form control errors
            const allTypeFields = [DOM.multipleChoiceFields, DOM.fillInFields, DOM.trueFalseFields];
            allTypeFields.forEach(fieldContainer => {
                const inputs = fieldContainer.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.removeAttribute('required');
                });
            });

            if (type === 'multiple_choice') {
                DOM.multipleChoiceFields.classList.remove('hidden');
                // Set required for multiple choice options
                DOM.mcOptionsContainer.querySelectorAll('input[name="mc_option"]').forEach(input => {
                    input.setAttribute('required', 'true');
                });

            } else if (type === 'fill_in_the_blank') {
                DOM.fillInFields.classList.remove('hidden');
                // Set required for fill in the blank answer
                DOM.fillInAnswerInput.setAttribute('required', 'true');

            } else if (type === 'true_false') {
                DOM.trueFalseFields.classList.remove('hidden');
                // True/False uses a select, which is implicitly validated
            }
        }
        
        /**
         * Renders the specified number of Multiple Choice option inputs.
         * @param {number} count - Number of options to render.
         * @param {Array<string>} [options=[]] - Optional array of current option values for restoring state.
         */
        function renderMCOptions(count, options = []) {
            DOM.mcOptionsContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const container = document.createElement('div');
                container.classList.add('option-input-container');
                
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'mc_option';
                input.placeholder = `Option ${i + 1}`;
                input.value = options[i] || ''; // Restore value if provided
                
                // Add required property only if the MC section is currently visible
                if (!DOM.multipleChoiceFields.classList.contains('hidden')) {
                     input.required = true;
                }

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'mc_correct_answer';
                radio.value = input.id = `mc-option-${i}`;
                radio.style.width = 'auto';

                const label = document.createElement('label');
                label.textContent = 'Correct';
                label.htmlFor = radio.id;
                label.style.width = '60px';
                label.style.fontWeight = 'normal';

                container.appendChild(input);
                container.appendChild(radio);
                container.appendChild(label);
                
                DOM.mcOptionsContainer.appendChild(container);
            }
        }
        
        function addMCOption() {
            const currentOptions = DOM.mcOptionsContainer.querySelectorAll('.option-input-container').length;
            // Get current values to maintain state after adding a new blank option
            const currentValues = Array.from(DOM.mcOptionsContainer.querySelectorAll('input[name="mc_option"]')).map(input => input.value);
            renderMCOptions(currentOptions + 1, currentValues);
        }

        /**
         * Handles both adding a new question and updating an existing one.
         * @param {Event} event - The form submission event.
         */
        async function saveQuestion(event) {
            event.preventDefault();
            DOM.adminFeedback.classList.add('hidden');

            // 1. Determine Category and Subcategory
            const newCategory = DOM.newCategoryInput.value.trim();
            const selectedCategory = DOM.adminCategorySelect.value;
            const category = newCategory || selectedCategory;
            
            const newSubcategory = DOM.newSubcategoryInput.value.trim();
            const selectedSubcategory = DOM.adminSubcategorySelect.value;
            const subcategory = newSubcategory || selectedSubcategory;

            if (!category || !subcategory) {
                 displayAdminFeedback('Category and Sub-Category must be defined.', 'incorrect-msg');
                 return;
            }

            const questionText = DOM.questionTextInput.value.trim();
            const questionType = DOM.questionTypeSelect.value;
            const explanation = DOM.explanationInput.value.trim();
            
            // NEW: Get Time Limit and validate
            const timeLimit = parseInt(DOM.timeLimitInput.value);

            if (!questionText || !explanation) {
                 displayAdminFeedback('Question Text and Explanation are required fields.', 'incorrect-msg');
                 return;
            }
            if (isNaN(timeLimit) || timeLimit < 5) {
                 displayAdminFeedback('Time Limit must be a number greater than 5 seconds.', 'incorrect-msg');
                 return;
            }


            let newQuestionData = {
                question: questionText,
                type: questionType,
                explanation: explanation,
                category: category,
                subcategory: subcategory,
                timeLimit: timeLimit, // NEW: Add timeLimit to the data model
                options: [],
                answer: ''
            };

            // 2. Validate and Extract Type-Specific Data
            if (questionType === 'multiple_choice') {
                const optionsElements = DOM.mcOptionsContainer.querySelectorAll('input[name="mc_option"]');
                const correctAnswerElement = DOM.mcOptionsContainer.querySelector('input[name="mc_correct_answer"]:checked');
                
                newQuestionData.options = Array.from(optionsElements).map(input => input.value.trim());

                if (newQuestionData.options.some(opt => opt === '')) {
                     displayAdminFeedback('All multiple-choice options must be filled.', 'incorrect-msg');
                     return;
                }

                if (!correctAnswerElement) {
                    displayAdminFeedback('The correct answer must be selected for multiple-choice.', 'incorrect-msg');
                    return;
                }
                
                const correctOptionIndex = parseInt(correctAnswerElement.value.split('-').pop());
                newQuestionData.answer = newQuestionData.options[correctOptionIndex];
            
            } else if (questionType === 'fill_in_the_blank') {
                newQuestionData.answer = DOM.fillInAnswerInput.value.trim();
                if (!newQuestionData.answer) {
                    displayAdminFeedback('The correct answer for Fill-in-the-Blank must be provided.', 'incorrect-msg');
                    return;
                }
                newQuestionData.options = [];
            
            } else if (questionType === 'true_false') {
                newQuestionData.answer = DOM.tfAnswerSelect.value;
                newQuestionData.options = ["True", "False"];
            }

            // 3. Add or Update Data Model
            if (questionIndexToEdit >= 0) {
                 // UPDATE existing question
                 ALL_QUESTIONS[questionIndexToEdit] = newQuestionData;
                 displayAdminFeedback(`‚úÖ Success! Question ${questionIndexToEdit + 1} updated and saved permanently.`, 'correct-msg');
            } else {
                // ADD new question
                ALL_QUESTIONS.push(newQuestionData);
                displayAdminFeedback(`‚úÖ Success! Question added and saved permanently. Total questions: ${ALL_QUESTIONS.length}`, 'correct-msg');
            }
            
            await saveQuestionsToRemoteFile(); // *** SERVER PERSISTENCE CALL ***
            
            // 4. Reset Form State
            
            // Capture the currently selected categories/subcategories before the reset
            const currentSelectedCat = DOM.adminCategorySelect.value;
            const currentSelectedSubcat = DOM.adminSubcategorySelect.value;
            
            resetAdminForm(); // This handles resetting to 'Add New Question' mode and refreshing all dropdowns.

            // Attempt to restore selection for quick follow-up edits/adds in the same category
            if (currentSelectedCat) DOM.adminCategorySelect.value = currentSelectedCat;
            
            // Trigger the chain manually based on the restored selection
            populateAdminSubcategorySelect(); 

            if (currentSelectedSubcat) DOM.adminSubcategorySelect.value = currentSelectedSubcat;
            
            // Ensure final button state is correct
            updateCategoryManagementButtons();
        }
        
        function displayAdminFeedback(message, className) {
            DOM.adminFeedback.className = `feedback ${className}`;
            DOM.adminFeedback.textContent = message;
            DOM.adminFeedback.classList.remove('hidden');
        }


        // -------------------------------------------------------------------
        // VI. EVENT LISTENERS & INITIALIZATION
        // -------------------------------------------------------------------

        // Welcome Screen Events
        DOM.userNameInput.addEventListener('input', checkNameInput);
        DOM.proceedToSettingsBtn.addEventListener('click', () => showSettingsModal(true)); 
        DOM.showAdminLoginBtn.addEventListener('click', () => showScreen('admin_login')); 

        // Admin Login Events
        DOM.adminLoginBtn.addEventListener('click', handleAdminLogin);
        DOM.backToWelcomeBtn.addEventListener('click', initWelcome);
        DOM.adminPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAdminLogin();
        });

        // Admin Panel Category Management Events
        DOM.adminCategorySelect.addEventListener('change', populateAdminSubcategorySelect);
        
        // FIX: Call updateCategoryManagementButtons to activate subcategory edit/delete buttons
        DOM.adminSubcategorySelect.addEventListener('change', () => {
             updateCategoryManagementButtons(); 
             populateQuestionSelect();
        });


        // Update button states when typing in new input fields
        DOM.newCategoryInput.addEventListener('input', updateCategoryManagementButtons);
        DOM.newSubcategoryInput.addEventListener('input', updateCategoryManagementButtons);
        
        // Category/Subcategory Edit/Delete
        DOM.editCategoryBtn.addEventListener('click', () => editCategoryOrSubcategory('category'));
        DOM.deleteCategoryBtn.addEventListener('click', () => deleteCategoryOrSubcategory('category'));
        DOM.editSubcategoryBtn.addEventListener('click', () => editCategoryOrSubcategory('subcategory'));
        DOM.deleteSubcategoryBtn.addEventListener('click', () => deleteCategoryOrSubcategory('subcategory'));

        // Admin Panel Question Management Events
        DOM.questionSelect.addEventListener('change', updateQuestionManagementButtons); // Change in selected item activates Load/Delete
        DOM.loadQuestionBtn.addEventListener('click', loadQuestionForEdit);
        DOM.deleteQuestionBtn.addEventListener('click', deleteQuestion);
        
        // Admin Question Form Events
        DOM.questionTypeSelect.addEventListener('change', handleQuestionTypeChange);
        DOM.addOptionBtn.addEventListener('click', addMCOption);
        DOM.addQuestionForm.addEventListener('submit', saveQuestion);
        DOM.clearFormBtn.addEventListener('click', resetAdminForm); 
        DOM.adminBackToWelcomeBtn.addEventListener('click', initWelcome);


        // Modal Events (Quiz Settings)
        DOM.categorySelect.addEventListener('change', populateSubcategories); 
        DOM.subcategorySelect.addEventListener('change', checkReadyToStart); 
        DOM.startQuizBtn.addEventListener('click', handleStartQuiz); 
        
        // Quiz & Results Actions
        DOM.submitBtn.addEventListener('click', handleSubmit);
        DOM.skipBtn.addEventListener('click', skipQuestion);
        DOM.restartBtn.addEventListener('click', resetAndGoToWelcome); 
        DOM.changeTopicBtn.addEventListener('click', () => showSettingsModal(true)); 
        DOM.toggleTranscriptBtn.addEventListener('click', toggleTranscript); 
        DOM.cancelQuizBtn.addEventListener('click', cancelQuiz);
        DOM.printTranscriptBtn.addEventListener('click', printTranscript);
        
        // Theme Toggle
        DOM.themeToggle.addEventListener('click', () => {
            DOM.container.classList.toggle('dark-mode');
            const isDark = DOM.container.classList.contains('dark-mode');
            DOM.themeToggle.textContent = isDark ? 'üí° Light Mode' : 'üåô Dark Mode';
        });

        // --- Initialization ---

        // NEW: This wrapper function allows us to use 'await'
        async function initializeApp() {
             // Load questions from server before anything else runs
             ALL_QUESTIONS = await loadAllQuestions(); 
             initWelcome();
        }

        document.addEventListener('DOMContentLoaded', initializeApp); 
    </script>
</body>
</html>