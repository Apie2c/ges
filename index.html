<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptQuiz - Modern HTML Quiz</title>
    
    <style>
        /* --- Color Variables for Theme Toggle --- */
        :root {
            --bg-color: #f4f4f9; 
            --text-color: #333;
            --card-bg: #fff;
            --primary-color: #4169e1;
            --primary-hover: #03c03c;
            --success-color: #4CAF50;
            --error-color: #f44336;
            --orange-color: #ff9800; /* New Orange */
            --admin-color: #5b3e94; /* Admin Panel Color */
            --delete-color: #dc3545;
            --edit-color: #ffc107;
            --load-color: #00bcd4; /* For Load/Edit Button */
        }

        .dark-mode {
            --bg-color: #121212; 
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --primary-color: #4169e1;
            --primary-hover: #5f9ea0;
        }

        /* --- Global Reset & Layout --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .quiz-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            padding: 30px;
            width: 100%;
            max-width: 700px;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }

        /* --- Header & Timer --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #ccc3;
            padding-bottom: 15px;
        }

        .timer {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* Highlight time low */
        .timer.time-critical {
            color: var(--error-color);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* --- Welcome Screen Styling --- */
        #welcome-screen {
            text-align: center;
            padding: 40px 0;
        }
        .logo-placeholder {
            /* Defines the container size for the image */
            width: 45%; 
            height: 45%; 
            margin: 0 auto 20px;
        }
        .logo-placeholder img {
            /* Styles for the actual image element */
            width: 100%; 
            height: 100%;
            border-radius: relative; /* Makes the image circular */
            object-fit: contain; 
            /*box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */
        }
        .name-input-container {
            margin-bottom: 30px;
        }
        #user-name-input {
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 80%;
            max-width: 300px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .selection-group {
            margin-top: 20px;
            text-align: left;
        }
        .selection-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            text-align: center;
        }
        .selection-group select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
        }
        .selection-group button {
            width: 100%;
        }

        /* --- Quiz Screen Styles --- */
        #question-text { font-size: 1.5em; margin-top: 0; color: var(--text-color); }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .option-btn { background-color: var(--bg-color); color: var(--text-color); border: 2px solid #ccc; padding: 15px; text-align: left; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, transform 0.1s; font-size: 1em; }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); transform: translateY(-2px); }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        #fill-in-input { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px solid #ccc; border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); box-sizing: border-box; font-size: 1em; }

        /* --- Buttons (General) --- */
        .main-btn, #theme-toggle, .secondary-btn, .admin-btn, .edit-btn, .delete-btn, .load-btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600; 
            transition: background-color 0.2s, opacity 0.2s; 
            margin-right: 10px; 
        }
        .main-btn { background-color: var(--primary-color); color: white; margin-top: 10px; }
        .main-btn:hover { background-color: var(--primary-hover); }
        .secondary-btn { background-color: #6c757d; color: white; margin-top: 10px; }
        .secondary-btn:hover { background-color: #5a6268; }
        .admin-btn { background-color: var(--admin-color); color: white; margin-top: 10px; }
        .admin-btn:hover { background-color: #4f3479; }
        .edit-btn { background-color: var(--edit-color); color: #212529; padding: 5px 10px; font-size: 0.9em; margin: 0 5px; }
        .edit-btn:hover { background-color: #e0a800; }
        .delete-btn { background-color: var(--delete-color); color: white; padding: 5px 10px; font-size: 0.9em; margin: 0; }
        .delete-btn:hover { background-color: #bd2130; }
        .load-btn { background-color: var(--load-color); color: white; padding: 5px 10px; font-size: 0.9em; margin: 0; }
        .load-btn:hover { background-color: #0097a7; }
        #theme-toggle { background-color: #ececec; color: #747373; padding: 2px 2px; margin-right: 0; }
        
        /* --- Feedback & State Styling --- */
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; }
        .feedback.correct-msg { background-color: var(--success-color); color: white; }
        .feedback.incorrect-msg { background-color: var(--error-color); color: white; }
        .feedback.edit-btn { background-color: var(--edit-color); color: #212529; } /* Use edit color for load feedback */
        .selected { border-color: var(--primary-color) !important; background-color: var(--primary-color) !important; color: white !important; }

        .correct { background-color: var(--success-color) !important; border-color: var(--success-color) !important; color: white !important; }
        .incorrect { background-color: var(--error-color) !important; border-color: var(--error-color) !important; color: white !important; }
        
        .hidden { display: none !important; }

        /* --- Results Styling --- */
        #score-circle {
            margin: 20px auto 30px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color);
            border: 4px solid #ccc;
            transition: border-color 0.3s;
        }

        #final-percent {
            font-size: 3em;
            font-weight: bold;
            transition: color 0.3s;
        }
        
        /* Dynamic Score Colors */
        .score-green { color: var(--success-color); border-color: var(--success-color) !important; }
        .score-orange { color: var(--orange-color); border-color: var(--orange-color) !important; }
        .score-red { color: var(--error-color); border-color: var(--error-color) !important; }
        
        /* --- Review/Transcript Styles (UPDATED) --- */
        #review-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ccc4;
        }

        .review-item {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            background-color: var(--bg-color);
            transition: background-color 0.3s;
        }
        
        .review-item.correct-review { border-left-color: var(--success-color); }
        .review-item.incorrect-review { border-left-color: var(--error-color); }

        .review-item p { margin: 5px 0; }
        .review-item strong { display: inline-block; width: 100px; font-weight: 600; }
        
        .review-explanation {
            margin-top: 10px;
            padding: 10px;
            border-top: 1px dashed #ccc;
            font-size: 0.9em;
        }
        
        .summary-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0 20px 0;
            padding: 10px 0;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        .summary-details p {
            margin: 0;
        }

        /* --- Admin Panel Styles --- */
        #admin-login-screen, #create-quiz-screen {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: var(--bg-color);
        }
        
        .management-container {
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .management-container select, .management-container input {
            flex-grow: 1;
        }
        
        .management-buttons {
            display: flex;
            gap: 5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="number"] { /* Added number input */
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-color);
            margin-top: 3px;
        }
        
        .type-specific-fields {
            margin-top: 15px;
            padding: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .option-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .option-input-container input {
            flex-grow: 1;
        }
        
        #edit-mode-indicator {
            padding: 10px;
            text-align: center;
            background-color: var(--edit-color);
            color: #212529;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* --- Print Styles (for Transcript) (UPDATED) --- */
        @media print {
            body { 
                background-color: white !important; 
                color: black !important; 
                display: block; 
                padding: 0;
            }
            .quiz-container { 
                box-shadow: none; 
                border: none; 
                width: auto; 
                max-width: none; 
                padding: 0;
            }
            /* Hide all UI that is not part of the transcript */
            header, 
            #quiz-screen, 
            #welcome-screen, 
            .modal-overlay, 
            .main-btn, 
            .secondary-btn, 
            #theme-toggle, 
            .selection-group button, 
            #admin-login-screen, 
            #create-quiz-screen,
            #toggle-transcript-btn, /* Hide the button used to show/hide */
            #print-transcript-btn, /* Hide the print button itself */
            #review-area.hidden /* Ensure it shows if the user prints */
            { 
                display: none !important; 
            }
            
            #results-screen { 
                display: block !important; 
                padding: 0; 
            }
            
            /* Show the review area for print */
            #review-area { 
                display: block !important; 
                margin-top: 0;
                padding-top: 10px;
            }
            
            /* Print Header */
            #results-screen h2 { margin-top: 0; }
            
            /* Review Item Styling for Print */
            .review-item { 
                border: 1px solid #ccc; 
                padding: 10px; 
                margin-bottom: 15px; 
                background-color: #f9f9f9; 
                border-left: 5px solid #333 !important; /* Use dark color for border */
                page-break-inside: avoid;
            }
            .review-item.correct-review { border-left-color: var(--success-color) !important; }
            .review-item.incorrect-review { border-left-color: var(--error-color) !important; }
            
            .review-explanation { border-top: 1px dashed #aaa; }

            /* Print style for the score circle, ensure text is readable */
            #score-circle { border: 2px solid #333 !important; background-color: #eee !important; }
            #final-percent { color: #333 !important; } 
            .score-green { color: var(--success-color) !important; }
            .score-orange { color: var(--orange-color) !important; }
            .score-red { color: var(--error-color) !important; }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <header>
            <div>
                <button id="cancel-quiz-btn" class="secondary-btn hidden">‚ùå Back</button>
            </div>
            <div style="display: flex; align-items: center;">
                <div id="timer-display" class="timer hidden">Time Left: <span id="time">N/A</span></div>
                <button id="theme-toggle" style="margin-left: 10px;">üåô Theme</button>
            </div>
        </header>

        <div id="welcome-screen">
            <div class="logo-placeholder">
                <img src="quiz-logo.png" alt="ScriptQuiz Logo">
            </div>
            <h1>Welcome to G.E.S. Aptitude Test Practice</h1>
            <p>Enter your name and click the button below to proceed</p>
            
            <div class="name-input-container">
                <input type="text" id="user-name-input" placeholder="Your Full Name" required>
            </div>
            
            <button id="proceed-to-settings-btn" class="main-btn">Proceed to Quiz</button>
            <button id="show-admin-login-btn" class="admin-btn">üîë Admin Login</button>
        </div>

        <div id="admin-login-screen" class="hidden">
            <h2>Admin Panel Login</h2>
            <p>Enter the administrator password to access the quiz creation tool.</p>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Admin Password" required>
            </div>
            <button id="admin-login-btn" class="admin-btn">Login</button>
            <button id="back-to-welcome-btn" class="secondary-btn">Cancel</button>
            <p id="admin-login-feedback" class="feedback hidden"></p>
        </div>

        <div id="create-quiz-screen" class="hidden">
            <h2>Quiz Administration</h2>
            <p>Welcome, Admin! Add, manage, or delete quiz questions and categories.</p>
            
            <div id="edit-mode-indicator" class="hidden">
                EDITING QUESTION <span id="question-id-display">N/A</span>. Click "Clear Form" to add a new question.
            </div>

            <form id="add-question-form">
                
                <div class="form-group">
                    <label>Manage / Add Category</label>
                    <div class="management-container">
                        <select id="admin-category-select">
                            <option value="">-- Select Existing Category --</option>
                        </select>
                        <div class="management-buttons">
                            <button type="button" class="edit-btn" id="edit-category-btn" disabled>‚úèÔ∏è Edit</button>
                            <button type="button" class="delete-btn" id="delete-category-btn" disabled>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <input type="text" id="new-category-input" placeholder="...or Enter New Category Name">

                    <label style="margin-top: 15px;">Manage / Add Sub-Category</label>
                    <div class="management-container">
                        <select id="admin-subcategory-select" disabled>
                            <option value="">-- Select Existing Sub-Category --</option>
                        </select>
                           <div class="management-buttons">
                            <button type="button" class="edit-btn" id="edit-subcategory-btn" disabled>‚úèÔ∏è Edit</button>
                            <button type="button" class="delete-btn" id="delete-subcategory-btn" disabled>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <input type="text" id="new-subcategory-input" placeholder="...or Enter New Sub-Category Name">
                </div>

                <div class="form-group">
                    <label>Edit or Delete Existing Question (Filter above first)</label>
                    <div class="management-container">
                        <select id="question-select" disabled>
                            <option value="">-- Select Question to Manage --</option>
                        </select>
                        <div class="management-buttons">
                            <button type="button" class="load-btn" id="load-question-btn" disabled>Load for Edit</button>
                            <button type="button" class="delete-btn" id="delete-question-btn" disabled>üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="question-text-input">Question Text</label>
                    <textarea id="question-text-input" rows="3" required placeholder="Type the quiz question here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="question-type-select">Question Type</label>
                    <select id="question-type-select" required>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="fill_in_the_blank">Fill in the Blank</option>
                        <option value="true_false">True/False</option>
                    </select>
                </div>

                <div id="multiple-choice-fields" class="type-specific-fields">
                    <label>Options (Minimum 2, check correct answer)</label>
                    <div id="mc-options-container">
                        </div>
                    <button type="button" class="secondary-btn" id="add-option-btn" style="width: auto;">+ Add Option</button>
                </div>

                <div id="fill-in-fields" class="type-specific-fields hidden">
                    <label for="fill-in-answer-input">Correct Answer (Case-insensitive match)</label>
                    <input type="text" id="fill-in-answer-input" placeholder="The single correct answer (e.g., 'cascading style sheets')">
                </div>
                
                <div id="true-false-fields" class="type-specific-fields hidden">
                    <label>Correct Answer</label>
                    <select id="tf-answer-select">
                        <option value="True">True</option>
                        <option value="False">False</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="explanation-input">Explanation/Reasoning</label>
                    <textarea id="explanation-input" rows="2" required placeholder="Explain why the answer is correct/incorrect."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="time-limit-input">Time Limit (Seconds)</label>
                    <input type="number" id="time-limit-input" value="15" min="5" required>
                </div>

                <button type="submit" class="admin-btn" id="save-question-btn" style="width: 100%; margin-top: 20px;">üíæ Add Question and Save</button>
                <button type="button" class="secondary-btn" id="clear-form-btn" style="width: 100%; margin-top: 10px;">Clear Form / New Question</button>
            </form>

            <p id="admin-feedback" class="feedback hidden"></p>
            <button id="admin-back-to-welcome-btn" class="secondary-btn" style="width: 100%; margin-top: 10px;">Exit Admin Panel</button>
        </div>


        <div id="quiz-screen" class="hidden">
            <div id="progress-indicator"></div>
            <h2 id="question-text"></h2>
            
            <div id="options-container" class="options-grid"></div>

            <input type="text" id="fill-in-input" placeholder="Type your answer here..." class="hidden">
            
            <div id="quiz-controls" style="display: flex; gap: 10px;">
                <button id="submit-btn" class="main-btn">Submit Answer</button>
                <button id="skip-btn" class="secondary-btn">Skip Question</button>
                <button id="next-question-btn" class="main-btn hidden">Next Question &rarr;</button>
            </div>
            
            <div id="feedback-message" class="feedback hidden"></div>
            <div id="explanation-area" class="hidden" style="margin-top: 15px; padding: 10px; border-left: 5px solid var(--primary-color); background-color: var(--bg-color); border-radius: 4px;">
                <strong>Explanation:</strong> <span id="explanation-text"></span>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <h2 id="results-greeting">Quiz Complete! üéâ</h2>
            <div class="summary-details">
                <p>Name: <strong id="transcript-name"></strong></p>
                <p>Category: <strong id="transcript-category"></strong></p>
                <p>Sub-Category: <strong id="transcript-subcategory"></strong></p>
                <p>Total Time Taken: <strong id="total-time-taken">0s</strong></p>
            </div>

            <div id="score-circle">
                <p style="margin: 0; font-size: 0.9em;">Final Score</p>
                <span id="final-percent">0%</span>
                <p style="margin: 0; font-size: 0.9em; margin-top: 5px;">(<span id="final-score">0 / 0</span>)</p>
            </div>
            
            <p id="grade-level" style="font-weight: bold; text-align: center; font-size: 1.2em;">Aggregate Grade: <strong id="aggregate-grade">N/A</strong></p>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="restart-btn" class="secondary-btn">Home</button>
                <button id="change-topic-btn" class="main-btn">New Quiz</button>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px; margin-bottom: 20px;">
                <button id="toggle-transcript-btn" class="secondary-btn">View Transcript</button>
                <button id="print-transcript-btn" class="secondary-btn">üñ®Ô∏è Print transcript (PDF)</button>
            </div>

            <div id="review-area"></div>
        </div>
    </div>

    <div id="settings-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Quiz Settings</h2>
            <p>Hello, <strong id="modal-user-name">User</strong>! Select your quiz topic.</p>
            
            <div class="selection-group">
                <label for="category-select">1. Select Main Category</label>
                <select id="category-select">
                    </select>
                
                <label for="subcategory-select">2. Select Sub-Category</label>
                <select id="subcategory-select" disabled>
                    <option value="">-- Select a Category First --</option>
                </select>

                <button id="start-quiz-btn" class="main-btn" disabled>Start Quiz</button>
            </div>
        </div>
    </div>

    <script>    
// -------------------------------------------------------------------
        // I. DATA MODEL & PERSISTENCE
        // -------------------------------------------------------------------

        const DEFAULT_QUESTIONS = [
            { id: 1, question: "Which CSS property is used to make an element's padding and border included in its total width?", type: "multiple_choice", options: ["box-shadow", "box-sizing: content-box", "box-sizing: border-box", "padding-mode"], answer: "box-sizing: border-box", explanation: "Setting 'box-sizing' to 'border-box' ensures that padding and border do not increase the element's overall dimensions.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 15, },
            { id: 2, question: "What does CSS stand for?", type: "fill_in_the_blank", answer: "cascading style sheets", explanation: "CSS stands for Cascading Style Sheets.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 20, },
            { id: 3, question: "The 'display: none' property hides an element but still reserves space for it. (True/False)", type: "true_false", options: ["True", "False"], answer: "False", explanation: "The 'visibility: hidden' property reserves space; 'display: none' removes the element entirely from the document flow.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 10, },
            { id: 4, question: "Which value is used for a position property to fix an element relative to the browser window?", type: "multiple_choice", options: ["static", "relative", "fixed", "sticky"], answer: "fixed", explanation: "'position: fixed' keeps the element in the same place even when the page scrolls.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 15, },
            { id: 5, question: "What is the CSS selector used to target all `<p>` elements inside a `<div>`?", type: "fill_in_the_blank", answer: "div p", explanation: "The descendant selector (space) targets elements inside another element.", category: "Web Development", subcategory: "CSS Basics", timeLimit: 25, },
            { id: 6, question: "JavaScript is primarily used for styling web pages. (True/False)", type: "true_false", options: ["True", "False"], answer: "False", explanation: "JavaScript is primarily used for adding interactivity and dynamic behavior; CSS is used for styling.", category: "Web Development", subcategory: "JavaScript", timeLimit: 10, },
            { id: 7, question: "What keyword declares a constant variable in JavaScript?", type: "multiple_choice", options: ["var", "let", "const", "static"], answer: "const", explanation: "The 'const' keyword is used to declare block-scoped, constant variables.", category: "Web Development", subcategory: "JavaScript", timeLimit: 15, },
            { id: 8, question: "What built-in method is used to execute a function once, after a specified delay?", type: "fill_in_the_blank", answer: "settimeout", explanation: "The `setTimeout()` function executes a specified function once after the delay.", category: "Web Development", subcategory: "JavaScript", timeLimit: 20, },
            { id: 9, question: "The `==` operator checks for value equality without considering data type. (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "The `==` operator performs type coercion, comparing values only. `===` checks both value and type.", category: "Web Development", subcategory: "JavaScript", timeLimit: 10, },
            { id: 10, question: "Which array method adds one or more elements to the end of an array and returns the new length?", type: "multiple_choice", options: ["unshift()", "shift()", "push()", "pop()"], answer: "push()", explanation: "The `push()` method adds elements to the end of an array.", category: "Web Development", subcategory: "JavaScript", timeLimit: 15, },
            { id: 11, question: "If all A's are B's, and all B's are C's, are all A's also C's? (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "This is a basic rule of transitive logic (A=>B and B=>C implies A=>C).", category: "General Knowledge", subcategory: "Logic", timeLimit: 10, },
            { id: 12, question: "What is the next number in the sequence: 1, 1, 2, 3, 5, 8, __?", type: "fill_in_the_blank", answer: "13", explanation: "This is the Fibonacci sequence, where the next number is the sum of the previous two (5 + 8 = 13).", category: "General Knowledge", subcategory: "Logic", timeLimit: 30, },
            { id: 13, question: "A statement must be either true or false, but not both. (True/False)", type: "true_false", options: ["True", "False"], answer: "True", explanation: "This is the law of excluded middle in classical logic.", category: "General Knowledge", subcategory: "Logic", timeLimit: 10, },
            { id: 14, question: "If a light switch is ON, and you flip it OFF, the light is now OFF. If you flip it ON again, the light is ON. This is an example of what type of relationship?", type: "multiple_choice", options: ["Inverse relationship", "Direct cause and effect", "Contingency", "Non-linear system"], answer: "Direct cause and effect", explanation: "The state of the light is directly determined by the state of the switch.", category: "General Knowledge", subcategory: "Logic", timeLimit: 15, },
            { id: 15, question: "A statement that is always true, regardless of the truth values of its components, is called a...", type: "fill_in_the_blank", answer: "tautology", explanation: "A tautology is a statement that is true in every possible interpretation, often used in formal logic.", category: "General Knowledge", subcategory: "Logic", timeLimit: 25, },
        ];
        
        let questions = JSON.parse(localStorage.getItem('quizQuestions')) || DEFAULT_QUESTIONS;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let userName = '';
        let quizTimer = null;
        let timeRemaining = 0;
        let startTime = 0;
        let selectedCategory = '';
        let selectedSubcategory = '';

        const SECRET_KEYWORD = "icewate"; 
        let SECURE_CONFIG = {
            ADMIN_PASSWORD: "icewater", 
            SHOW_ADMIN_LOGIN: true 
        };

        function checkSecretAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const secret = urlParams.get('secret');
            if (secret === SECRET_KEYWORD) {
                SECURE_CONFIG.SHOW_ADMIN_LOGIN = true; 
                return true;
            }
            return false;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.quiz-container > div').forEach(div => {
                if (!div.classList.contains('modal-overlay')) div.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');

            const header = document.querySelector('header');
            const timerDisplay = document.getElementById('timer-display');
            const cancelBtn = document.getElementById('cancel-quiz-btn');

            if (screenId === 'quiz-screen') {
                header.style.justifyContent = 'space-between';
                timerDisplay.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
            } else {
                timerDisplay.classList.add('hidden');
                cancelBtn.classList.add('hidden');
            }
            document.getElementById('settings-modal-overlay').classList.add('hidden');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            document.getElementById('theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è Theme' : 'üåô Theme';
        }

        function loadTheme() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è Theme';
            } else {
                document.getElementById('theme-toggle').textContent = 'üåô Theme';
            }
        }

        function loadCategories() {
            const categorySelect = document.getElementById('category-select');
            const subcategorySelect = document.getElementById('subcategory-select');
            categorySelect.innerHTML = '<option value="">-- Select Main Category --</option>';
            subcategorySelect.innerHTML = '<option value="">-- Select a Category First --</option>';

            const categories = {};
            questions.forEach(q => {
                if (!categories[q.category]) categories[q.category] = new Set();
                categories[q.category].add(q.subcategory);
            });

            Object.keys(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            categorySelect.onchange = () => {
                const selectedCat = categorySelect.value;
                selectedSubcategory = '';
                subcategorySelect.innerHTML = '<option value="">-- Select a Sub-Category --</option>';
                subcategorySelect.disabled = true;

                if (selectedCat) {
                    categories[selectedCat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subcategorySelect.appendChild(option);
                    });
                    subcategorySelect.disabled = false;
                }
                document.getElementById('start-quiz-btn').disabled = true;
            };

            subcategorySelect.onchange = () => {
                selectedSubcategory = subcategorySelect.value;
                selectedCategory = categorySelect.value;
                document.getElementById('start-quiz-btn').disabled = !selectedSubcategory;
            };
        }

        function initQuiz() {
            if (quizTimer) clearInterval(quizTimer);
            currentQuestions = questions.filter(q => q.category === selectedCategory && q.subcategory === selectedSubcategory);
            if (currentQuestions.length === 0) {
                alert("No questions found.");
                showScreen('welcome-screen');
                return;
            }
            shuffleArray(currentQuestions);
            currentQuestions.forEach(q => {
                if (q.type === 'multiple_choice' || q.type === 'true_false') {
                    q.options = [...q.options];
                    shuffleArray(q.options);
                }
            });
            currentQuestionIndex = 0;
            userAnswers = [];
            startTime = Date.now();
            showScreen('quiz-screen');
            loadQuestion(currentQuestionIndex);
        }

        function startTimer(timeLimit) {
            if (quizTimer) clearInterval(quizTimer);
            timeRemaining = timeLimit;
            const timerDisplay = document.getElementById('time');
            timerDisplay.textContent = timeRemaining;
            const timerDiv = document.getElementById('timer-display');
            timerDiv.classList.remove('time-critical');

            quizTimer = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = timeRemaining;
                if (timeRemaining <= 5) timerDiv.classList.add('time-critical');
                if (timeRemaining <= 0) {
                    clearInterval(quizTimer);
                    submitAnswer(true); 
                }
            }, 1000);
        }

        function loadQuestion(index) {
            if (index >= currentQuestions.length) return finishQuiz();
            const currentQ = currentQuestions[index];
            document.getElementById('question-text').textContent = `${index + 1}. ${currentQ.question}`;
            const optionsContainer = document.getElementById('options-container');
            const fillInInput = document.getElementById('fill-in-input');
            const submitBtn = document.getElementById('submit-btn');
            const nextBtn = document.getElementById('next-question-btn');
            const skipBtn = document.getElementById('skip-btn');
            const feedbackMsg = document.getElementById('feedback-message');
            const explanationArea = document.getElementById('explanation-area');
            const progressIndicator = document.getElementById('progress-indicator');

            optionsContainer.innerHTML = '';
            fillInInput.value = '';
            feedbackMsg.classList.add('hidden');
            explanationArea.classList.add('hidden');
            submitBtn.classList.add('hidden'); 
            skipBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            fillInInput.classList.add('hidden');
            optionsContainer.style.pointerEvents = 'auto';
            progressIndicator.textContent = `Question ${index + 1} of ${currentQuestions.length}`;

            startTimer(currentQ.timeLimit);
            
            if (currentQ.type === 'multiple_choice' || currentQ.type === 'true_false') {
                currentQ.options.forEach((optionText) => {
                    const button = document.createElement('button');
                    button.classList.add('option-btn');
                    button.textContent = optionText;
                    button.onclick = () => submitAnswer(false, optionText); 
                    optionsContainer.appendChild(button);
                });
            } else if (currentQ.type === 'fill_in_the_blank') {
                fillInInput.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
                fillInInput.focus();
            }
            currentQuestionIndex = index;
        }

        function submitAnswer(isSkipped = false, selectedOption = null) {
            clearInterval(quizTimer);
            const currentQ = currentQuestions[currentQuestionIndex];
            let userAnswer = '';
            let isCorrect = false;
            let timeTaken = currentQ.timeLimit - timeRemaining;
            const optionsContainer = document.getElementById('options-container');
            const fillInInput = document.getElementById('fill-in-input');
            const feedbackMsg = document.getElementById('feedback-message');
            const explanationArea = document.getElementById('explanation-area');

            if (isSkipped || timeRemaining <= 0) {
                userAnswer = isSkipped ? 'Skipped' : 'Time Expired';
                timeTaken = currentQ.timeLimit;
                isCorrect = false;
            } else if (currentQ.type === 'multiple_choice' || currentQ.type === 'true_false') {
                userAnswer = selectedOption.trim();
                isCorrect = userAnswer === currentQ.answer;
            } else if (currentQ.type === 'fill_in_the_blank') {
                userAnswer = fillInInput.value.trim();
                isCorrect = userAnswer.toLowerCase() === currentQ.answer.toLowerCase();
            }

            optionsContainer.style.pointerEvents = 'none';
            document.getElementById('submit-btn').classList.add('hidden');
            document.getElementById('skip-btn').classList.add('hidden');
            document.getElementById('next-question-btn').classList.remove('hidden');

            if (currentQ.type === 'multiple_choice' || currentQ.type === 'true_false') {
                optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent.trim() === currentQ.answer) btn.classList.add('correct');
                    else if (btn.textContent.trim() === userAnswer && !isCorrect) btn.classList.add('incorrect');
                });
            }
            
            feedbackMsg.classList.remove('hidden');
            if (isSkipped || timeRemaining <= 0) {
                feedbackMsg.textContent = isSkipped ? 'Question Skipped.' : 'Time Expired!';
                feedbackMsg.className = 'feedback incorrect-msg';
            } else if (isCorrect) {
                feedbackMsg.textContent = '‚úÖ Correct!';
                feedbackMsg.className = 'feedback correct-msg';
            } else {
                feedbackMsg.textContent = `‚ùå Incorrect. Correct answer: ${currentQ.answer}`;
                feedbackMsg.className = 'feedback incorrect-msg';
            }
            document.getElementById('explanation-text').textContent = currentQ.explanation;
            explanationArea.classList.remove('hidden');

            userAnswers.push({
                questionId: currentQ.id, question: currentQ.question, userAnswer, correctAnswer: currentQ.answer,
                isCorrect, timeTaken, explanation: currentQ.explanation, type: currentQ.type
            });
        }

        function finishQuiz() {
            if (quizTimer) clearInterval(quizTimer);
            const totalCorrect = userAnswers.filter(a => a.isCorrect).length;
            const totalQuestions = currentQuestions.length;
            const finalPercent = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const totalTime = Math.round((Date.now() - startTime) / 1000);

            showScreen('results-screen');
            document.getElementById('results-greeting').textContent = `Quiz Complete, ${userName}! üéâ`;
            document.getElementById('final-percent').textContent = `${finalPercent}%`;
            document.getElementById('final-score').textContent = `${totalCorrect} / ${totalQuestions}`;
            document.getElementById('total-time-taken').textContent = `${totalTime}s`;
            document.getElementById('transcript-name').textContent = userName;
            document.getElementById('transcript-category').textContent = selectedCategory;
            document.getElementById('transcript-subcategory').textContent = selectedSubcategory;
            
            const scoreCircle = document.getElementById('score-circle');
            const percentEl = document.getElementById('final-percent');
            scoreCircle.className = ''; 
            percentEl.className = ''; 
            
            let gradeText = (finalPercent >= 80) ? 'Excellent (Distinction)' : (finalPercent >= 60) ? 'Good (Credit)' : 'Needs Improvement (Pass)';
            scoreCircle.classList.add(finalPercent >= 80 ? 'score-green' : finalPercent >= 60 ? 'score-orange' : 'score-red');
            percentEl.classList.add(finalPercent >= 80 ? 'score-green' : finalPercent >= 60 ? 'score-orange' : 'score-red');
            document.getElementById('aggregate-grade').textContent = gradeText;
            generateReviewTranscript();
        }

        function generateReviewTranscript() {
            const reviewArea = document.getElementById('review-area');
            reviewArea.innerHTML = '<h3>Detailed Transcript</h3>';
            reviewArea.classList.add('hidden');
            userAnswers.forEach((answer, index) => {
                const item = document.createElement('div');
                item.classList.add('review-item', answer.isCorrect ? 'correct-review' : 'incorrect-review');
                item.innerHTML = `
                    <p><strong>Q${index + 1}:</strong> ${answer.question}</p>
                    <p><strong>Your Answer:</strong> ${answer.userAnswer}</p>
                    <p><strong>Correct Answer:</strong> ${answer.correctAnswer}</p>
                    <p><strong>Result:</strong> ${answer.isCorrect ? '‚úÖ CORRECT' : '‚ùå INCORRECT'}</p>
                    <p><strong>Time Taken:</strong> ${answer.timeTaken}s</p>
                    <div class="review-explanation"><strong>Reasoning:</strong> ${answer.explanation}</div>`;
                reviewArea.appendChild(item);
            });
            document.getElementById('toggle-transcript-btn').textContent = 'View Transcript';
        }

        // -------------------------------------------------------------------
        // VI. ADMIN FUNCTIONS (Management Logic)
        // -------------------------------------------------------------------

        function saveQuestionsToStorage() {
            localStorage.setItem('quizQuestions', JSON.stringify(questions));
            loadCategories();
            populateAdminSelects();
        }

        function populateAdminSelects() {
            const adminCategorySelect = document.getElementById('admin-category-select');
            const adminSubcategorySelect = document.getElementById('admin-subcategory-select');
            const questionSelect = document.getElementById('question-select');

            adminCategorySelect.innerHTML = '<option value="">-- Select Existing Category --</option>';
            adminSubcategorySelect.innerHTML = '<option value="">-- Select Existing Sub-Category --</option>';
            questionSelect.innerHTML = '<option value="">-- Select Question to Manage --</option>';

            const categories = {};
            questions.forEach(q => {
                if (!categories[q.category]) categories[q.category] = new Set();
                categories[q.category].add(q.subcategory);
            });

            Object.keys(categories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category; option.textContent = category;
                adminCategorySelect.appendChild(option);
            });

            adminCategorySelect.onchange = () => {
                const selectedCat = adminCategorySelect.value;
                const hasValue = selectedCat !== "";
                document.getElementById('edit-category-btn').disabled = !hasValue;
                document.getElementById('delete-category-btn').disabled = !hasValue;
                
                adminSubcategorySelect.innerHTML = '<option value="">-- Select Existing Sub-Category --</option>';
                adminSubcategorySelect.disabled = !hasValue;
                if (hasValue) {
                    categories[selectedCat].forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub; opt.textContent = sub;
                        adminSubcategorySelect.appendChild(opt);
                    });
                }
                questionSelect.innerHTML = '<option value="">-- Select Question to Manage --</option>';
                questionSelect.disabled = true;
            };

            adminSubcategorySelect.onchange = () => {
                const selectedSub = adminSubcategorySelect.value;
                const hasValue = selectedSub !== "";
                document.getElementById('edit-subcategory-btn').disabled = !hasValue;
                document.getElementById('delete-subcategory-btn').disabled = !hasValue;
                
                questionSelect.innerHTML = '<option value="">-- Select Question to Manage --</option>';
                questionSelect.disabled = !hasValue;
                if (hasValue) {
                    questions.filter(q => q.category === adminCategorySelect.value && q.subcategory === selectedSub)
                        .forEach(q => {
                            const opt = document.createElement('option');
                            opt.value = q.id; opt.textContent = `${q.id}: ${q.question.substring(0, 40)}...`;
                            questionSelect.appendChild(opt);
                        });
                }
            };

            questionSelect.onchange = () => {
                const hasValue = questionSelect.value !== "";
                document.getElementById('load-question-btn').disabled = !hasValue;
                document.getElementById('delete-question-btn').disabled = !hasValue;
            };
        }
        
        function createInitialMCOptions() {
            const container = document.getElementById('mc-options-container');
            container.innerHTML = '';
            for(let i = 0; i < 4; i++) addMultipleChoiceOption();
        }
        
        function addMultipleChoiceOption(value = '', isCorrect = false) {
            const container = document.getElementById('mc-options-container');
            const div = document.createElement('div');
            div.classList.add('option-input-container');
            div.innerHTML = `
                <input type="radio" name="correct-option" ${isCorrect ? 'checked' : ''} required>
                <input type="text" class="mc-option-text" value="${value}" placeholder="Option Text" required>
                <button type="button" class="delete-btn" style="width: auto;">-</button>`;
            div.querySelector('.delete-btn').onclick = () => {
                if (container.children.length > 2) container.removeChild(div);
                else alert('Need at least 2 options.');
            };
            container.appendChild(div);
        }

        // --- Action Handlers for the "Non-functioning" buttons ---
        function handleEditCategory() {
            const oldName = document.getElementById('admin-category-select').value;
            const newName = prompt("New category name:", oldName);
            if (newName && newName !== oldName) {
                questions.forEach(q => { if(q.category === oldName) q.category = newName; });
                saveQuestionsToStorage();
            }
        }

        function handleDeleteCategory() {
            const name = document.getElementById('admin-category-select').value;
            if (confirm(`Delete category "${name}"?`)) {
                questions = questions.filter(q => q.category !== name);
                saveQuestionsToStorage();
            }
        }

        function handleEditSubcategory() {
            const cat = document.getElementById('admin-category-select').value;
            const oldSub = document.getElementById('admin-subcategory-select').value;
            const newSub = prompt("New sub-category name:", oldSub);
            if (newSub && newSub !== oldSub) {
                questions.forEach(q => { if(q.category === cat && q.subcategory === oldSub) q.subcategory = newSub; });
                saveQuestionsToStorage();
            }
        }

        function handleDeleteSubcategory() {
            const cat = document.getElementById('admin-category-select').value;
            const sub = document.getElementById('admin-subcategory-select').value;
            if (confirm(`Delete sub-category "${sub}"?`)) {
                questions = questions.filter(q => !(q.category === cat && q.subcategory === sub));
                saveQuestionsToStorage();
            }
        }

        function handleLoadQuestion() {
            const id = parseInt(document.getElementById('question-select').value);
            const q = questions.find(q => q.id === id);
            if (!q) return;

            document.getElementById('question-text-input').value = q.question;
            document.getElementById('question-type-select').value = q.type;
            document.getElementById('explanation-input').value = q.explanation;
            document.getElementById('time-limit-input').value = q.timeLimit;
            document.getElementById('question-type-select').dispatchEvent(new Event('change'));

            if (q.type === 'multiple_choice') {
                const container = document.getElementById('mc-options-container');
                container.innerHTML = '';
                q.options.forEach(opt => addMultipleChoiceOption(opt, opt === q.answer));
            } else if (q.type === 'fill_in_the_blank') {
                document.getElementById('fill-in-answer-input').value = q.answer;
            } else {
                document.getElementById('tf-answer-select').value = q.answer;
            }

            document.getElementById('add-question-form').dataset.editId = q.id;
            document.getElementById('save-question-btn').textContent = 'üíæ Update Question and Save';
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('question-id-display').textContent = q.id;
        }

        function handleDeleteQuestion() {
            const id = parseInt(document.getElementById('question-select').value);
            if (confirm("Delete this question?")) {
                questions = questions.filter(q => q.id !== id);
                saveQuestionsToStorage();
            }
        }

        // -------------------------------------------------------------------
        // VII. INITIALIZATION & EVENT LISTENERS
        // -------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadCategories();
            checkSecretAccess();
            if (!SECURE_CONFIG.SHOW_ADMIN_LOGIN) document.getElementById('show-admin-login-btn').classList.add('hidden');

            // Admin Logic Binding
            document.getElementById('edit-category-btn').onclick = handleEditCategory;
            document.getElementById('delete-category-btn').onclick = handleDeleteCategory;
            document.getElementById('edit-subcategory-btn').onclick = handleEditSubcategory;
            document.getElementById('delete-subcategory-btn').onclick = handleDeleteSubcategory;
            document.getElementById('load-question-btn').onclick = handleLoadQuestion;
            document.getElementById('delete-question-btn').onclick = handleDeleteQuestion;

            document.getElementById('proceed-to-settings-btn').onclick = () => {
                userName = document.getElementById('user-name-input').value.trim();
                if (userName) {
                    document.getElementById('modal-user-name').textContent = userName;
                    document.getElementById('settings-modal-overlay').classList.remove('hidden');
                } else alert("Please enter your name.");
            };

            document.getElementById('start-quiz-btn').onclick = () => {
                selectedCategory = document.getElementById('category-select').value;
                selectedSubcategory = document.getElementById('subcategory-select').value;
                if (selectedCategory && selectedSubcategory) initQuiz();
            };

            document.getElementById('submit-btn').onclick = () => submitAnswer(false, null);
            document.getElementById('skip-btn').onclick = () => submitAnswer(true);
            document.getElementById('next-question-btn').onclick = () => {
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
            };
            
            document.getElementById('cancel-quiz-btn').onclick = () => {
                if(confirm("Cancel quiz?")) {
                    if (quizTimer) clearInterval(quizTimer);
                    showScreen('welcome-screen');
                }
            };

            document.getElementById('restart-btn').onclick = () => showScreen('welcome-screen');
            document.getElementById('change-topic-btn').onclick = () => document.getElementById('settings-modal-overlay').classList.remove('hidden');
            document.getElementById('toggle-transcript-btn').onclick = (e) => {
                const isHidden = document.getElementById('review-area').classList.toggle('hidden');
                e.target.textContent = isHidden ? 'View Transcript' : 'Hide Transcript';
            };
            document.getElementById('print-transcript-btn').onclick = () => {
                document.getElementById('review-area').classList.remove('hidden');
                window.print();
            };
            
            document.getElementById('theme-toggle').onclick = toggleTheme;
            document.getElementById('show-admin-login-btn').onclick = () => showScreen('admin-login-screen');
            document.getElementById('admin-login-btn').onclick = () => {
                if (document.getElementById('admin-password').value === SECURE_CONFIG.ADMIN_PASSWORD) {
                    showScreen('create-quiz-screen');
                    populateAdminSelects();
                    createInitialMCOptions();
                } else alert("Invalid password.");
            };

            document.getElementById('back-to-welcome-btn').onclick = () => showScreen('welcome-screen');
            document.getElementById('admin-back-to-welcome-btn').onclick = () => showScreen('welcome-screen');

            document.getElementById('question-type-select').onchange = (e) => {
                ['multiple-choice-fields', 'fill-in-fields', 'true-false-fields'].forEach(id => document.getElementById(id).classList.add('hidden'));
                if (e.target.value === 'multiple_choice') document.getElementById('multiple-choice-fields').classList.remove('hidden');
                else if (e.target.value === 'fill_in_the_blank') document.getElementById('fill-in-fields').classList.remove('hidden');
                else document.getElementById('true-false-fields').classList.remove('hidden');
            };
            
            document.getElementById('add-option-btn').onclick = () => addMultipleChoiceOption();
            document.getElementById('clear-form-btn').onclick = () => {
                document.getElementById('add-question-form').reset();
                document.getElementById('add-question-form').dataset.editId = "";
                document.getElementById('edit-mode-indicator').classList.add('hidden');
                document.getElementById('save-question-btn').textContent = 'üíæ Add Question and Save';
                createInitialMCOptions();
            };

            document.getElementById('add-question-form').onsubmit = (e) => {
                e.preventDefault();
                const type = document.getElementById('question-type-select').value;
                let answer = "";
                let options = [];

                if (type === 'multiple_choice') {
                    const optionInputs = document.querySelectorAll('.mc-option-text');
                    const radioInputs = document.querySelectorAll('input[name="correct-option"]');
                    optionInputs.forEach((inp, i) => {
                        options.push(inp.value);
                        if (radioInputs[i].checked) answer = inp.value;
                    });
                } else if (type === 'fill_in_the_blank') {
                    answer = document.getElementById('fill-in-answer-input').value;
                } else {
                    answer = document.getElementById('tf-answer-select').value;
                    options = ["True", "False"];
                }

                const editId = document.getElementById('add-question-form').dataset.editId;
                const newQ = {
                    id: editId ? parseInt(editId) : Date.now(),
                    question: document.getElementById('question-text-input').value,
                    type,
                    answer,
                    options,
                    explanation: document.getElementById('explanation-input').value,
                    category: document.getElementById('admin-category-select').value || document.getElementById('new-category-input').value,
                    subcategory: document.getElementById('admin-subcategory-select').value || document.getElementById('new-subcategory-input').value,
                    timeLimit: parseInt(document.getElementById('time-limit-input').value)
                };

                if (editId) questions = questions.map(q => q.id === newQ.id ? newQ : q);
                else questions.push(newQ);
                
                saveQuestionsToStorage();
                alert("Saved successfully!");
                document.getElementById('clear-form-btn').click();
            };
        });

    </script>
</body>
</html>